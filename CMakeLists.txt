cmake_minimum_required(VERSION 3.10)
project(r3c LANGUAGES CXX)

# =====================================
# 🔧 기본 설정
# =====================================
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_EXPORT_COMPILE_COMMANDS ON)

# =====================================
# 📦 Include 경로 (모든 OS 지원)
# =====================================
# - macOS(Homebrew): /opt/homebrew/include, /usr/local/include
# - Ubuntu(apt): /usr/include
# - Windows(curl): ${CMAKE_SOURCE_DIR}/include
include_directories(
    ${CMAKE_SOURCE_DIR}/include
    /opt/homebrew/include
    /usr/local/include
    /usr/include
)

# =====================================
# 🔍 NASM 확인
# =====================================
find_program(NASM_EXECUTABLE nasm)
if (NASM_EXECUTABLE)
    message(STATUS "✅ NASM found: ${NASM_EXECUTABLE}")
else()
    message(FATAL_ERROR "❌ NASM not found. Please install NASM before building.")
endif()

# =====================================
# 📁 소스 파일
# =====================================
set(SRC_FILES
    src/main.cpp
    src/docgen.cpp
    src/formatter.cpp
    src/manifest.cpp
    src/pkgmgr.cpp
    src/r3c.cpp
    src/r3cpkg.cpp
)

# =====================================
# ⚙️ 실행 파일
# =====================================
add_executable(r3c ${SRC_FILES})

# =====================================
# 💾 출력 디렉토리
# =====================================
set_target_properties(r3c PROPERTIES
    RUNTIME_OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}/bin"
)

# =====================================
# 🧪 조건부 테스트
# =====================================
if(EXISTS "${CMAKE_SOURCE_DIR}/tests/test_basic.cpp")
    message(STATUS "🧪 Test file found → enabling test build...")
    enable_testing()
    add_executable(r3c_tests tests/test_basic.cpp)
    add_test(NAME r3c_tests COMMAND r3c_tests)
else()
    message(WARNING "⚠️ No tests found (tests/test_basic.cpp missing) → skipping test target.")
endif()

# =====================================
# 🧾 빌드 정보 출력
# =====================================
message(STATUS "=====================================================")
message(STATUS "[r3c] Rust → NASM → Executable build pipeline enabled")
message(STATUS "C++ Compiler : ${CMAKE_CXX_COMPILER}")
message(STATUS "Build Type   : ${CMAKE_BUILD_TYPE}")
message(STATUS "Source Dir   : ${CMAKE_SOURCE_DIR}")
message(STATUS "=====================================================")
