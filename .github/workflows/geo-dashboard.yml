name: R3C Global Activity Map

on:
  schedule:
    - cron: "0 2 * * *"   # ë§¤ì¼ ìƒˆë²½ 2ì‹œ UTCì— ìžë™ ê°±ì‹ 
  workflow_dispatch:

permissions:
  contents: write

jobs:
  geo-stats:
    name: Generate Geo Dashboard
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y jq python3-pip && pip install matplotlib geopandas pandas

      - name: Fetch GitHub traffic data
        id: traffic
        run: |
          echo "ðŸ“¡ Fetching R3C traffic data..."
          curl -s -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/traffic/views" > traffic.json
          echo "âœ… traffic.json downloaded"

      - name: Generate Geo Graph
        run: |
          python3 <<'PYCODE'
          import json, pandas as pd, matplotlib.pyplot as plt
          from datetime import datetime
          from pathlib import Path
          import geopandas as gpd

          # Dummy geo data (GitHub APIëŠ” êµ­ê°€ë³„ ìœ„ì¹˜ì •ë³´ë¥¼ ì§ì ‘ ì•ˆ ì¤Œ)
          # ë”°ë¼ì„œ IP êµ­ê°€ë¥¼ ì¶”ì •í•  ìˆ˜ ìžˆëŠ” ë°ì´í„°ëŠ” ë³„ë„ë¡œ í™•ìž¥ ê°€ëŠ¥.
          # ì—¬ê¸°ì„œëŠ” ì¡°íšŒìˆ˜ ê¸°ë°˜ ì§€ì—­ ë¶„í¬ ì˜ˆì‹œ ìƒì„±.
          f = Path("traffic.json")
          data = json.load(f.open())
          views = data.get("views", [])
          df = pd.DataFrame(views)
          if not len(df):
              print("No traffic data found")
              exit(0)
          df["timestamp"] = pd.to_datetime(df["timestamp"])
          df["day"] = df["timestamp"].dt.strftime("%Y-%m-%d")

          plt.figure(figsize=(10,5))
          plt.plot(df["day"], df["count"], marker="o", label="Views")
          plt.plot(df["day"], df["uniques"], marker="x", label="Unique Viewers")
          plt.title("R3C Daily Traffic Activity")
          plt.xlabel("Date")
          plt.ylabel("Count")
          plt.grid(True)
          plt.legend()
          plt.tight_layout()
          Path("logs").mkdir(exist_ok=True)
          plt.savefig("logs/r3c_traffic_chart.png")
          print("âœ… Traffic chart generated")
          PYCODE

      - name: Update README dashboard
        run: |
          echo "### ðŸŒ R3C Global Activity" > GEO.md
          echo "" >> GEO.md
          echo "![Traffic Chart](logs/r3c_traffic_chart.png)" >> GEO.md
          echo "" >> GEO.md
          echo "_ìžë™ ê°±ì‹ : $(date -u '+%Y-%m-%d %H:%M UTC')_" >> GEO.md

          awk '/<!-- GEO_START -->/{flag=1;print;system("cat GEO.md");next}/<!-- GEO_END -->/{flag=0} !flag' README.md > README_new.md
          mv README_new.md README.md

      - name: Commit and push
        run: |
          git config --global user.name "r3c-bot"
          git config --global user.email "r3c-bot@users.noreply.github.com"
          git add README.md logs/r3c_traffic_chart.png
          git commit -m "update: global activity chart [auto]" || echo "no changes"
          git push
