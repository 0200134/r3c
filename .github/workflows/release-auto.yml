name: üöÄ Auto Release (Version + Changelog + Artifact)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: üß© Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ÌÉúÍ∑∏ ÎπÑÍµêÎ•º ÏúÑÌï¥ Ï†ÑÏ≤¥ Í∏∞Î°ù ÌïÑÏöî

      - name: ‚öôÔ∏è Setup build environment
        run: sudo apt-get update && sudo apt-get install -y cmake g++ nasm zip

      - name: üß± Build R3C binary
        run: |
          cmake -B build -S .
          cmake --build build --parallel 4
          mkdir -p dist
          cp build/r3c dist/ || true
          zip -r dist/r3c_build.zip dist/*

      - name: üßÆ Calculate next version
        id: version
        run: |
          TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "Latest tag: $TAG"
          IFS='.' read -r MAJOR MINOR PATCH <<<"${TAG#v}"
          PATCH=$((PATCH + 1))
          NEW_TAG="v$MAJOR.$MINOR.$PATCH"
          echo "NEW_TAG=$NEW_TAG" >> $GITHUB_ENV
          echo "Next version: $NEW_TAG"

      - name: üßæ Generate changelog
        id: changelog
        run: |
          echo "üßæ Generating changelog..."
          echo "## $NEW_TAG ($(date +'%Y-%m-%d'))" > changelog.txt
          git log -1 --pretty=format:"- %s" >> changelog.txt
          echo -e "\n" >> changelog.txt
          cat changelog.txt
          cat changelog.txt >> CHANGELOG.md

      - name: üíæ Commit changelog
        run: |
          git config user.name "r3c-bot"
          git config user.email "bot@r3c.local"
          git add CHANGELOG.md
          git commit -m "üßæ update changelog for $NEW_TAG" || echo "No changes"
          git push

      - name: üè∑Ô∏è Create new tag
        run: |
          git tag $NEW_TAG
          git push origin $NEW_TAG

      - name: üöÄ Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag_name: ${{ env.NEW_TAG }}
          name: "R3C ${NEW_TAG}"
          body_path: changelog.txt
          files: |
            dist/r3c_build.zip
