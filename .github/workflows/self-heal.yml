name: R3C Self-Healing Auto-Fix (v2)

on:
  workflow_run:
    workflows: ["R3C Autonomous Build Line (v4)"]
    types: [completed]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  selfheal:
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download build log
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: r3c-build-log
          path: ./logs

      - name: Analyze build log and detect cause
        id: analysis
        run: |
          LOG="./logs/build_log.txt"
          FIX="none"
          if grep -q "nlohmann/json.hpp" "$LOG"; then
            echo "Detected missing json.hpp â†’ fixing"
            mkdir -p include/nlohmann
            curl -fsSL https://raw.githubusercontent.com/nlohmann/json/develop/single_include/nlohmann/json.hpp \
              -o include/nlohmann/json.hpp
            FIX="json-include"
          elif grep -q "symbol(s) not found" "$LOG"; then
            echo "Detected missing function â†’ stub fix"
            echo "// stub auto-generated" >> src/auto_stub.cpp
            echo "int test_main(){return 0;}" >> src/auto_stub.cpp
            FIX="stub"
          else
            echo "No known fix pattern found."
          fi
          echo "fix_type=$FIX" >> $GITHUB_OUTPUT

      - name: Commit and create fix branch
        if: steps.analysis.outputs.fix_type != 'none'
        run: |
          git config --global user.name "r3c-bot"
          git config --global user.email "r3c-bot@users.noreply.github.com"
          BRANCH="auto-fix-${{ steps.analysis.outputs.fix_type }}-${{ github.run_number }}"
          git checkout -b "$BRANCH"
          git add .
          git commit -m "auto-fix: ${{ steps.analysis.outputs.fix_type }}"
          git push origin "$BRANCH"

      - name: Create PR automatically
        if: steps.analysis.outputs.fix_type != 'none'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "ðŸ¤– Auto-Fix: ${{ steps.analysis.outputs.fix_type }}"
          body: |
            **Automatic fix triggered by failed build**
            - Fix Type: `${{ steps.analysis.outputs.fix_type }}`
            - Workflow Run: `${{ github.event.workflow_run.id }}`
            - Status: âœ… Self-Heal applied
          branch: "auto-fix-${{ steps.analysis.outputs.fix_type }}-${{ github.run_number }}"
