name: R3C Self-Heal Auto-Trigger + Auto-Merge (v4)

on:
  workflow_run:
    workflows: ["R3C Cross-Platform Build & Test (v4 Stable)"]
    types: [completed]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  heal:
    name: Auto Fix Build Failures
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup git
        run: |
          git config --global user.name "r3c-bot"
          git config --global user.email "r3c-bot@users.noreply.github.com"

      - name: Analyze build logs
        run: |
          echo "🩺 Analyzing build logs..."
          mkdir -p logs
          cp -f build/CMakeFiles/CMakeError.log logs/ 2>/dev/null || true
          cp -f build/CMakeFiles/CMakeOutput.log logs/ 2>/dev/null || true

      - name: Self-Heal common errors
        run: |
          echo "⚙️ Running self-heal..."
          if [ ! -f include/r3c.hpp ]; then
            mkdir -p include
            echo "#pragma once\nint run_pipeline();" > include/r3c.hpp
            echo "🪄 Created include/r3c.hpp"
          fi

      - name: Commit and push fix branch
        run: |
          git checkout -b auto-heal-${{ github.run_id }}
          git add include/ logs/ || true
          git commit -m "🤖 auto-heal: repair missing headers" || echo "No fix needed."
          git push origin auto-heal-${{ github.run_id }} || echo "Push skipped"

      - name: Create PR for fix
        id: create_pr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "🤖 auto-heal: build fix"
          title: "🤖 Auto-Heal Build Fix #${{ github.run_id }}"
          body: |
            This PR was generated automatically after a failed build.
            - Missing headers / includes repaired
            - Logs attached under `/logs/`
          branch: auto-heal-${{ github.run_id }}

  merge:
    name: Auto-Merge if Build Passes
    needs: heal
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    if: ${{ always() }}

    steps:
      - name: Wait for rebuild
        uses: lewagon/wait-on-check-action@v1.3.3
        with:
          ref: main
          check-name: "R3C Cross-Platform Build & Test (v4 Stable)"
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 30
          timeout: 1200

      - name: Auto-Merge healed PR
        if: success()
        uses: pascalgn/automerge-action@v0.15.6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MERGE_METHOD: squash
          MERGE_COMMIT_MESSAGE: "✅ Auto-merged successful self-heal build"
