name: R3C Auto Rebuild After Issue Close (v7)

on:
  issues:
    types: [closed]

permissions:
  contents: write
  actions: write
  issues: write

jobs:
  rebuild:
    if: contains(github.event.issue.title, 'R3C Build Failed')
    runs-on: ubuntu-latest

    steps:
      - name: Notify rebuild start
        uses: peter-evans/create-or-update-comment@v3
        with:
          issue-number: ${{ github.event.issue.number }}
          body: |
            ✅ **이슈가 닫혔습니다.**
            - R3C는 자동으로 재빌드를 시작합니다.
            - 빌드 결과는 완료 후 다시 이곳에 게시됩니다.
            🔁 **Auto-Rebuild Triggered**

      - name: Trigger build workflow
        id: trigger
        uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: "R3C Autonomous Build Line (v4)"
          ref: "main"

      - name: Wait for rebuild to finish
        run: |
          echo "⌛ 빌드가 끝날 때까지 2분 대기..."
          sleep 120

      - name: Get latest workflow runs
        id: runs
        uses: actions/github-script@v7
        with:
          script: |
            const runs = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: "R3C Autonomous Build Line (v4)",
              branch: "main",
              per_page: 1
            });
            const url = runs.data.workflow_runs[0].html_url;
            core.setOutput("url", url);

      - name: Comment with rebuild result
        uses: peter-evans/create-or-update-comment@v3
        with:
          issue-number: ${{ github.event.issue.number }}
          body: |
            🧱 **자동 재빌드가 완료되었습니다.**
            👉 [워크플로 실행 결과 확인하기](${{ steps.runs.outputs.url }})
            _(R3C Auto Rebuild v7)_

      - name: Reopen issue if build failed
        if: always() && contains(steps.runs.outputs.url, 'failed')
        uses: peter-evans/close-issue@v3
        with:
          issue-number: ${{ github.event.issue.number }}
          state: open
          comment: |
            ⚠️ **자동 재빌드 실패**
            - 이슈가 다시 열렸습니다.
            - 로그를 확인하세요.
