name: R3C Auto Rebuild After Issue Close (v7)

on:
  issues:
    types: [closed]

permissions:
  contents: write
  actions: write
  issues: write

jobs:
  rebuild:
    if: contains(github.event.issue.title, 'R3C Build Failed')
    runs-on: ubuntu-latest

    steps:
      - name: Notify rebuild start
        uses: peter-evans/create-or-update-comment@v3
        with:
          issue-number: ${{ github.event.issue.number }}
          body: |
            âœ… **ì´ìŠˆê°€ ë‹«í˜”ìŠµë‹ˆë‹¤.**
            - R3CëŠ” ìë™ìœ¼ë¡œ ì¬ë¹Œë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.
            - ë¹Œë“œ ê²°ê³¼ëŠ” ì™„ë£Œ í›„ ë‹¤ì‹œ ì´ê³³ì— ê²Œì‹œë©ë‹ˆë‹¤.
            ğŸ” **Auto-Rebuild Triggered**

      - name: Trigger build workflow
        id: trigger
        uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: "R3C Autonomous Build Line (v4)"
          ref: "main"

      - name: Wait for rebuild to finish
        run: |
          echo "âŒ› ë¹Œë“œê°€ ëë‚  ë•Œê¹Œì§€ 2ë¶„ ëŒ€ê¸°..."
          sleep 120

      - name: Get latest workflow runs
        id: runs
        uses: actions/github-script@v7
        with:
          script: |
            const runs = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: "R3C Autonomous Build Line (v4)",
              branch: "main",
              per_page: 1
            });
            const url = runs.data.workflow_runs[0].html_url;
            core.setOutput("url", url);

      - name: Comment with rebuild result
        uses: peter-evans/create-or-update-comment@v3
        with:
          issue-number: ${{ github.event.issue.number }}
          body: |
            ğŸ§± **ìë™ ì¬ë¹Œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.**
            ğŸ‘‰ [ì›Œí¬í”Œë¡œ ì‹¤í–‰ ê²°ê³¼ í™•ì¸í•˜ê¸°](${{ steps.runs.outputs.url }})
            _(R3C Auto Rebuild v7)_

      - name: Reopen issue if build failed
        if: always() && contains(steps.runs.outputs.url, 'failed')
        uses: peter-evans/close-issue@v3
        with:
          issue-number: ${{ github.event.issue.number }}
          state: open
          comment: |
            âš ï¸ **ìë™ ì¬ë¹Œë“œ ì‹¤íŒ¨**
            - ì´ìŠˆê°€ ë‹¤ì‹œ ì—´ë ¸ìŠµë‹ˆë‹¤.
            - ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.
