name: ğŸ§¹ Repository Cleanup (Auto Maintenance)

on:
  schedule:
    - cron: "0 0 1 * *"     # ë§¤ì›” 1ì¼ 00ì‹œ UTC ì‹¤í–‰
  workflow_dispatch:        # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì •

jobs:
  cleanup:
    runs-on: ubuntu-latest
    
    # ğŸš¨ ì¤‘ìš”: ë¦´ë¦¬ìŠ¤ ì‚­ì œë¥¼ ìœ„í•´ 'releases: write' ê¶Œí•œì´ í•„ìˆ˜ì…ë‹ˆë‹¤.
    permissions:
      contents: write
      releases: write 

    steps:
      - name: ğŸ§­ Checkout repository
        uses: actions/checkout@v4

      # --- ğŸ—‘ï¸ 3ì¼ ì´ìƒëœ Release ë° Tag ì‚­ì œ ---
      - name: ğŸ—‘ï¸ Delete older releases and associated tags
        uses: dev-drprasad/delete-older-releases@v0.3.4
        with:
          # ê°œìˆ˜ ê¸°ì¤€ ìœ ì§€(keep_latest)ëŠ” ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
          keep_latest: 0 
          # ìƒì„±ëœ ì§€ 3ì¼ ì´ˆê³¼ëœ ë¦´ë¦¬ìŠ¤ë¥¼ ì‚­ì œ
          delete_expired_data: 3 
          # ì‚­ì œë˜ëŠ” ë¦´ë¦¬ìŠ¤ì™€ ì—°ê²°ëœ íƒœê·¸ë„ í•¨ê»˜ ì‚­ì œ
          delete_associated_tags: true 
        env:
          # GITHUB_TOKENì„ ì‚¬ìš©í•˜ì—¬ ì‚­ì œ ê¶Œí•œ ë¶€ì—¬
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      # -----------------------------------

      - name: ğŸ§¹ Git history garbage collection
        run: |
          echo "Running aggressive git cleanup..."
          # Git ì €ì¥ì†Œ ìµœì í™” ë° ë¶ˆí•„ìš”í•œ ê°ì²´ ì •ë¦¬
          git gc --prune=now --aggressive || true
          du -sh .git

      - name: ğŸ—‘ï¸ Delete old workflow caches
        uses: actions/github-script@v7
        with:
          script: |
            // 7ì¼ ì´ìƒ ì ‘ê·¼ë˜ì§€ ì•Šì€ workflow ìºì‹œë¥¼ ì‚­ì œ
            const caches = await github.rest.actions.listCaches({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            for (const cache of caches.data.actions_caches) {
              const lastAccess = new Date(cache.last_accessed_at);
              const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
              if (lastAccess < weekAgo) {
                await github.rest.actions.deleteCacheById({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  cache_id: cache.id
                });
                core.info(`ğŸ—‘ï¸ Deleted old cache: ${cache.key}`);
              }
            }

      - name: ğŸ§¾ Delete artifacts older than 7 days
        uses: geekyeggo/delete-artifact@v5
        with:
          # 7ì¼ë³´ë‹¤ ì˜¤ë˜ëœ ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ì‚­ì œ
          age: '7 days'

      - name: âœ… Done
        run: echo "Cleanup complete âœ…"
