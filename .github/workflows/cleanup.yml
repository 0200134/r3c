name: 🧹 Repository Cleanup (Auto Maintenance)

on:
  schedule:
    - cron: "0 0 1 * *"     # 매월 1일 00시 UTC 실행
  workflow_dispatch:        # 수동 실행 가능하도록 설정

jobs:
  cleanup:
    runs-on: ubuntu-latest
    
    # 🚨 중요: 릴리스 삭제를 위해 'releases: write' 권한이 필수입니다.
    permissions:
      contents: write
      releases: write 

    steps:
      - name: 🧭 Checkout repository
        uses: actions/checkout@v4

      # --- 🗑️ 3일 이상된 Release 및 Tag 삭제 ---
      - name: 🗑️ Delete older releases and associated tags
        uses: dev-drprasad/delete-older-releases@v0.3.4
        with:
          # 개수 기준 유지(keep_latest)는 사용하지 않음
          keep_latest: 0 
          # 생성된 지 3일 초과된 릴리스를 삭제
          delete_expired_data: 3 
          # 삭제되는 릴리스와 연결된 태그도 함께 삭제
          delete_associated_tags: true 
        env:
          # GITHUB_TOKEN을 사용하여 삭제 권한 부여
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      # -----------------------------------

      - name: 🧹 Git history garbage collection
        run: |
          echo "Running aggressive git cleanup..."
          # Git 저장소 최적화 및 불필요한 객체 정리
          git gc --prune=now --aggressive || true
          du -sh .git

      - name: 🗑️ Delete old workflow caches
        uses: actions/github-script@v7
        with:
          script: |
            // 7일 이상 접근되지 않은 workflow 캐시를 삭제
            const caches = await github.rest.actions.listCaches({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            for (const cache of caches.data.actions_caches) {
              const lastAccess = new Date(cache.last_accessed_at);
              const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
              if (lastAccess < weekAgo) {
                await github.rest.actions.deleteCacheById({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  cache_id: cache.id
                });
                core.info(`🗑️ Deleted old cache: ${cache.key}`);
              }
            }

      - name: 🧾 Delete artifacts older than 7 days
        uses: geekyeggo/delete-artifact@v5
        with:
          # 7일보다 오래된 빌드 아티팩트 삭제
          age: '7 days'

      - name: ✅ Done
        run: echo "Cleanup complete ✅"
