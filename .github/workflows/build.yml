name: 🧩 R3C Cross-Platform Build

on:
  push:
  pull_request:

jobs:
  build:
    name: 🧱 Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: 🧰 Checkout repository
        uses: actions/checkout@v4

      - name: ⚙️ Set up CMake
        uses: jwlawson/actions-setup-cmake@v2
        with:
          cmake-version: "3.28.3"

      - name: 🔧 Configure (Generate build files)
        run: |
          echo "⚙️ Configuring for $RUNNER_OS..."
          if [[ "$RUNNER_OS" == "Windows" ]]; then
            cmake -B build -S . -G "Visual Studio 17 2022" -A x64 -DCMAKE_BUILD_TYPE=Release
          else
            cmake -B build -S . -DCMAKE_BUILD_TYPE=Release
          fi

      - name: 🧩 Pre-Build permission fix (macOS/Linux)
        if: runner.os != 'Windows'
        run: |
          echo "🔧 Fixing permission for stub scripts..."
          chmod +x scripts/generate_stubs.sh || true

      - name: 🚀 Build (Auto Retry up to 3 times)
        shell: bash
        run: |
          echo "⚙️ Building on $RUNNER_OS..."
          attempt=1
          while [ $attempt -le 3 ]; do
            echo "🔁 Attempt $attempt..."

            if [[ "$RUNNER_OS" == "Windows" ]]; then
              echo "🪟 Using MSBuild with /m (parallel build)"
              cmake --build "build" --config Release -- /m > build_log.txt 2>&1
            else
              echo "🐧 Using Make/Ninja with -j4"
              cmake --build build --config Release -- -j4 > build_log.txt 2>&1
            fi

            if [ $? -eq 0 ]; then
              echo "✅ Build success"
              cat build_log.txt | tail -n 10
              echo "success=true" >> $GITHUB_OUTPUT
              exit 0
            else
              echo "⚠️ Build failed attempt $attempt"
              cat build_log.txt | tail -n 20
              ((attempt++))
            fi
          done

          echo "❌ Build failed after 3 attempts"
          cat build_log.txt || true
          echo "success=false" >> $GITHUB_OUTPUT
          exit 1

      - name: 📦 Upload build logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build_logs_${{ matrix.os }}
          path: build_log.txt
