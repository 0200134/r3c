name: âš™ï¸ R3C Cross-Platform Autonomous Build (v7.0 Self-Healing)

on:
  push:
  pull_request:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}

    steps:
      - name: ğŸ§© Checkout repository
        uses: actions/checkout@v4

      # -------------------------------------------------------------
      # â‘  Self-Fix ë‹¨ê³„ : ìë™ìœ¼ë¡œ include/json ëˆ„ë½ ë³µêµ¬
      # -------------------------------------------------------------
      - name: ğŸ§  Self-Fix before build
        run: |
          echo "ğŸ©¹ Running pre-build self-fix..."
          mkdir -p include/nlohmann
          # r3c.hpp ìë™ ìƒì„±
          if [ ! -f include/r3c.hpp ]; then
            echo "Creating include/r3c.hpp..."
            cat > include/r3c.hpp <<'EOF'
#pragma once
#include <string>
#include <vector>
#include <cstdio>

int run_pipeline(const std::vector<std::string>& args,
                 const std::string& manifest,
                 bool emit_asm,
                 bool emit_rust,
                 const std::string& out_dir,
                 bool verbose);

inline void r3c_banner() {
    printf("=====================================================\n");
    printf("[r3c] Rust LTS transpiler + NASM bootstrap pipeline\n");
    printf("=====================================================\n");
}
EOF
          fi

          # json.hpp ìë™ ë‹¤ìš´ë¡œë“œ
          if [ ! -f include/nlohmann/json.hpp ]; then
            echo "Downloading nlohmann/json.hpp..."
            curl -L https://raw.githubusercontent.com/nlohmann/json/develop/single_include/nlohmann/json.hpp \
              -o include/nlohmann/json.hpp
          fi

          # r3cpkg.cppì— json include ì‚½ì…
          if [ -f src/r3cpkg.cpp ]; then
            if ! grep -q "nlohmann/json.hpp" src/r3cpkg.cpp; then
              echo "Injecting include into r3cpkg.cpp"
              sed -i '1i #include <nlohmann/json.hpp>\nusing json = nlohmann::json;\n' src/r3cpkg.cpp || true
            fi
          fi

      # -------------------------------------------------------------
      # â‘¡ ì˜ì¡´ì„± ì„¤ì¹˜
      # -------------------------------------------------------------
      - name: ğŸ§± Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: sudo apt update && sudo apt install -y cmake g++ nasm

      - name: ğŸ§± Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: brew install cmake nasm || true

      - name: ğŸ§± Setup Windows build tools
        if: runner.os == 'Windows'
        shell: bash
        run: choco install nasm cmake --yes || true

      # -------------------------------------------------------------
      # â‘¢ CMake êµ¬ì„± ë° ë¹Œë“œ ì‹œë„
      # -------------------------------------------------------------
      - name: ğŸ§© Configure project
        shell: bash
        run: cmake -B build -S . -DCMAKE_VERBOSE_MAKEFILE=ON

      - name: ğŸ—ï¸ Build with 3 retries
        shell: bash
        run: |
          echo "âš™ï¸ Building on $RUNNER_OS..."
          for i in 1 2 3; do
            echo "ğŸ” Attempt $i..."
            if cmake --build build --config Release --parallel 4; then
              echo "âœ… Build succeeded on attempt $i"
              exit 0
            else
              echo "âš ï¸ Build failed attempt $i"
            fi
          done
          echo "âŒ Build failed after 3 attempts"
          exit 1

      # -------------------------------------------------------------
      # â‘£ ì‹¤íŒ¨ ë¡œê·¸ í‘œì‹œ (debug)
      # -------------------------------------------------------------
      - name: ğŸ§  Show last 100 lines
        if: failure()
        shell: bash
        run: |
          echo "ğŸ§© Showing last 100 lines of logs..."
          find build -type f | grep -E ".log|CMake.*txt" | head -n 1 | xargs -r tail -n 100 || true

      # -------------------------------------------------------------
      # â‘¤ Auto Commit Fix (optional)
      # -------------------------------------------------------------
      - name: ğŸ’¾ Commit and Push Fixes
        if: failure()
        run: |
          git config user.name "r3c-bot"
          git config user.email "bot@r3c.local"
          git add include src CMakeLists.txt || true
          git commit -m "ğŸ¤– auto-fix (build.yml self-healing pass)" || echo "No changes"
          git push || echo "No push needed"
