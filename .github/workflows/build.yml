name: R3C Build & Test

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up NASM
        uses: ilammy/setup-nasm@v1.4.1

      - name: Install MinGW-w64
        run: |
          choco install mingw --version=13.2.0 -y
          echo "PATH=C:\\ProgramData\\chocolatey\\lib\\mingw\\tools\\install\\mingw64\\bin;$PATH" >> $env:GITHUB_PATH

      - name: Configure with CMake
        run: cmake -B build -S . -G "MinGW Makefiles"

      - name: Build project
        run: cmake --build build --config Release

      - name: Run transpiler test
        run: |
          build\\r3c.exe --emit-asm --emit-asm-from-rust --asm-out build\\test.asm
          nasm -f win64 build\\test.asm -o build\\test.obj
          g++ build\\test.obj -o build\\test.exe
          echo "âœ… Transpile + assemble + link succeeded."

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: r3c-build
          path: build/
