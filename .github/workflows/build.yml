name: R3C Build & Test

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install NASM
        run: |
          choco install nasm -y
          echo "C:\Program Files\NASM" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          nasm -v

      - name: Install MinGW-w64
        run: |
          choco install mingw --version=13.2.0 -y
          echo "C:\ProgramData\chocolatey\lib\mingw\tools\install\mingw64\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          gcc --version

      - name: Configure CMake
        run: cmake -B build -S . -G "MinGW Makefiles"

      - name: Build R3C
        run: cmake --build build --config Release

      - name: Run transpiler test
        working-directory: build
        run: |
          .\r3c.exe --emit-asm --emit-asm-from-rust --asm-out out.asm
          nasm -f win64 out.asm -o out.obj
          g++ out.obj -o out.exe
          echo "âœ… Transpile + assemble + link succeeded."

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: r3c-build
          path: build/
