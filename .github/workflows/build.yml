name: üîñ R3C Autonomous Stable Release v7.8 (3OS + PureGCC + macOS Toolchain + Funding + Metrics)

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '.github/workflows/**'
  schedule:
    - cron: "0 0 * * *"   # Îß§Ïùº Ïò§Ï†Ñ 9Ïãú (KST)
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: stable-release
  cancel-in-progress: false

jobs:
  build-and-release:
    name: "3OS Pure GCC Build"
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    env:
      TAG: v${{ github.run_number }}-${{ matrix.os }}-auto-v7.8

    steps:
      - name: üß≠ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ==========================================================
      # ü™ü Windows ‚Äî MinGW GCC
      # ==========================================================
      - name: üß± Build on Windows (Pure MinGW)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          echo "üèóÔ∏è Building on Windows with MinGW..."
          choco install mingw -y
          export PATH="/c/ProgramData/chocolatey/bin:/c/tools/mingw64/bin:$PATH"
          which g++
          g++ --version
          unset VSINSTALLDIR VCINSTALLDIR WindowsSdkDir
          cmake -E env CC=gcc CXX=g++ cmake -G "MinGW Makefiles" -B build -DCMAKE_BUILD_TYPE=Release
          cmake --build build --target r3c_cli
          ls -lah build

      # ==========================================================
      # üêß Linux ‚Äî Native GCC
      # ==========================================================
      - name: üß± Build on Linux
        if: runner.os == 'Linux'
        run: |
          echo "üèóÔ∏è Building on Linux..."
          gcc --version
          cmake -B build -DCMAKE_BUILD_TYPE=Release
          cmake --build build --target r3c_cli
          ls -lah build

      # ==========================================================
      # üçé macOS ‚Äî Homebrew GNU GCC + Toolchain File (Clang ÏôÑÏ†Ñ Ï∞®Îã®)
      # ==========================================================
      - name: üß± Build on macOS (GNU GCC Toolchain)
        if: runner.os == 'macOS'
        run: |
          echo "üèóÔ∏è Building on macOS with GNU GCC Toolchain..."
          brew update
          brew install gcc
          GCC_PATH=$(brew --prefix gcc)
          export CC="${GCC_PATH}/bin/gcc-13"
          export CXX="${GCC_PATH}/bin/g++-13"
          echo "‚úÖ Using compiler: $($CXX --version | head -n1)"
          echo "üîß Forcing CMake to ignore AppleClang..."

          cat > gcc-toolchain.cmake <<'EOF'
          set(CMAKE_SYSTEM_NAME Darwin)
          set(CMAKE_C_COMPILER /usr/local/bin/gcc-13)
          set(CMAKE_CXX_COMPILER /usr/local/bin/g++-13)
          set(CMAKE_C_COMPILER_ID GNU)
          set(CMAKE_CXX_COMPILER_ID GNU)
          set(CMAKE_C_COMPILER_FORCED TRUE)
          set(CMAKE_CXX_COMPILER_FORCED TRUE)
          set(CMAKE_TRY_COMPILE_TARGET_TYPE "STATIC_LIBRARY")
          EOF

          cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE=gcc-toolchain.cmake
          cmake --build build --target r3c_cli --config Release
          ls -lah build

      # ==========================================================
      # üß™ Smoke Test
      # ==========================================================
      - name: üîé Smoke Test
        shell: bash
        run: |
          exe=$(find build -type f \( -name "r3c_cli" -o -name "r3c_cli.exe" \) | head -n1 || true)
          if [ -n "$exe" ]; then
            echo "‚úÖ Found executable: $exe"
            "$exe" --help || echo "‚ö†Ô∏è CLI test skipped."
          else
            echo "‚ö†Ô∏è r3c_cli not found!"
          fi

      # ==========================================================
      # üì¶ Package & Hash
      # ==========================================================
      - name: üì¶ Package & Hash
        shell: bash
        run: |
          mkdir -p dist
          ARCHIVE="r3c-${{ matrix.os }}.tar.gz"
          tar -czf "dist/$ARCHIVE" -C build .
          python3 - << 'PY'
import hashlib, os
p = "dist/" + os.environ.get("ARCHIVE","archive.tar.gz")
h = hashlib.sha256()
with open(p,"rb") as f:
    for b in iter(lambda:f.read(1024*1024), b""):
        h.update(b)
open(f"dist/SHA256SUMS-${{ matrix.os }}.txt","w").write(f"{h.hexdigest()}  {os.path.basename(p)}\n")
print("‚úÖ SHA256:", h.hexdigest())
PY

      - name: üíæ Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: r3c-${{ matrix.os }}
          path: dist/
          if-no-files-found: error
          retention-days: 7

  # ==========================================================
  # üìä Release + Funding + Metrics
  # ==========================================================
  release-and-report:
    name: "üìä Release + Auto Funding + Metrics"
    runs-on: ubuntu-latest
    needs: build-and-release

    steps:
      - name: üß≠ Checkout repository
        uses: actions/checkout@v4

      - name: üì• Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: release_dist

      - name: üßÆ Combine hashes
        run: |
          find release_dist -type f -name "SHA256SUMS-*.txt" -exec cat {} + > release_dist/SHA256SUMS.txt
          cat release_dist/SHA256SUMS.txt

      - name: ü™∂ Generate tag
        id: tag
        run: |
          TAG="v$(date -u +'%y.%m.%d-%H%M')-auto-v7.8"
          echo "TAG=$TAG" >> $GITHUB_ENV

      - name: üìä Fetch OpenCollective Funding Data
        run: |
          echo "üì° Fetching OpenCollective data..."
          curl -fsSL -H 'Accept: application/json' https://opencollective.com/r3c-foundation.json -o funding.json || echo '{"balance":0,"backersCount":0}' > funding.json
          total=$(jq -r '(.balance // .collective.stats.balance // .stats.balance // 0)/100' funding.json)
          backers=$(jq -r '(.backersCount // .collective.stats.backersCount // .stats.backersCount // 0)' funding.json)
          [[ "$total" =~ ^[0-9]+(\.[0-9]+)?$ ]] || total=0
          [[ "$backers" =~ ^[0-9]+$ ]] || backers=0
          echo "total=$total" >> $GITHUB_ENV
          echo "backers=$backers" >> $GITHUB_ENV
          echo "‚úÖ Total funding: $${total}, Backers: ${backers}"

      - name: üìà GitHub Traffic Metrics
        run: |
          echo "üìä Gathering traffic metrics..."
          curl -s -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.WORKFLOW_PAT }}" \
            https://api.github.com/repos/${{ github.repository }}/traffic/views > traffic.json
          views=$(jq -r '.count // 0' traffic.json)
          uniques=$(jq -r '.uniques // 0' traffic.json)
          echo "views=$views" >> $GITHUB_ENV
          echo "uniques=$uniques" >> $GITHUB_ENV
          echo "‚úÖ Traffic: ${views} views (${uniques} unique)"

      - name: üßæ Create release notes
        run: |
          {
            echo "### R3C v7.8 Pure GCC + macOS Toolchain + Metrics"
            echo ""
            echo "‚úÖ 3OS Pure GCC (No LLVM / No Clang / No MSVC)"
            echo "üí∞ Total Funding: $${total} USD"
            echo "üë• Active Supporters: ${backers}"
            echo "üìä Traffic (14d): ${views} views, ${uniques} unique"
            echo "üïò Daily Auto-Build (09:00 KST)"
            echo ""
            echo "üì¶ SHA256 checksums:"
            cat release_dist/SHA256SUMS.txt
            echo ""
            echo "_Generated on $(date -u)_"
          } > release_dist/RELEASE_NOTE.txt

      - name: üß± Publish GitHub Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.WORKFLOW_PAT }}
        with:
          tag_name: ${{ env.TAG }}
          name: "R3C ${{ env.TAG }} (Pure GCC + macOS Toolchain + Funding + Metrics)"
          body_path: release_dist/RELEASE_NOTE.txt
          files: |
            release_dist/**/r3c-*.tar.gz
            release_dist/SHA256SUMS.txt

      - name: üßæ Update README with Metrics
        run: |
          echo "üìÑ Updating README.md metrics..."
          awk '/<!-- FUNDING-SECTION-START -->/{flag=1;print;print "";print "### ‚ù§Ô∏è Support the R3C Ecosystem";print "";next}/<!-- FUNDING-SECTION-END -->/{flag=0;print "";print "Latest Release: **'${TAG}'**";print 'Total Funding: **$'${total}' USD**';print 'Active Supporters: **'${backers}'**';print 'Traffic (14d): **'${views}' views / ' ${uniques} ' unique**';print '';print '[![OpenCollective](https://img.shields.io/badge/OpenCollective-r3c--foundation-2ea44f?logo=opencollective)](https://opencollective.com/r3c-foundation)';print '[![GitHub Sponsors](https://img.shields.io/badge/Sponsor-via%20GitHub-orange?logo=github)](https://github.com/sponsors/r3c-foundation)';print "";flag=0}flag==0' README.md > tmp && mv tmp README.md
          git config user.name "github-actions"
          git config user.email "actions@users.noreply.github.com"
          git add README.md
          git commit -m "üìä Auto-update README with funding + traffic metrics (v7.8)"
          git push

      - name: ‚úÖ Done
        run: echo "R3C v7.8 GCC + macOS Toolchain + Funding + Metrics complete ‚úÖ"
