name: ğŸ”– R3C Foundation Auto Stable Release (Full LTS Ecosystem v3 Final)

on:
  push:
    branches: [ main ]
  schedule:
    - cron: "0 0 * * *"  # ë§¤ì¼ ìì • ìë™ ì‹¤í–‰
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: foundation-lts-release
  cancel-in-progress: false

env:
  HOMEBREW_NO_AUTO_UPDATE: 1
  HOMEBREW_NO_INSTALL_CLEANUP: 1

jobs:
  build:
    name: "ğŸ§± Build on ${{ matrix.os }} (Pure GCC)"
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      # ============================================================
      # ğŸ§­ Checkout Repository
      # ============================================================
      - name: ğŸ§­ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ============================================================
      # ğŸ§± Install GCC (Linux)
      # ============================================================
      - name: ğŸ§± Install GCC (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update -y
          sudo apt-get install -y build-essential gcc g++
          gcc --version
          g++ --version

      # ============================================================
      # ğŸ§± Install GCC (macOS)
      # ============================================================
      - name: ğŸ§± Install GCC (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install gcc
          GCC_PREFIX=$(brew --prefix gcc)
          echo "âœ… GCC prefix: $GCC_PREFIX"
          ${GCC_PREFIX}/bin/gcc-14 --version || true
          ${GCC_PREFIX}/bin/g++-14 --version || true

      # ============================================================
      # ğŸ§± Install and Configure MinGW (Windows)
      # ============================================================
      - name: ğŸ§± Install and Configure MinGW (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Write-Host "ğŸš« Removing MSVC-related paths..."
          $env:Path = ($env:Path.Split(';') | Where-Object {$_ -notmatch 'Microsoft Visual Studio'}) -join ';'

          Write-Host "ğŸ§± Installing MinGW..."
          choco install mingw --installargs 'ADD_CMAKE_TO_PATH=System' -y

          $possiblePaths = @(
            "C:\\ProgramData\\mingw64\\mingw64\\bin",
            "C:\\ProgramData\\mingw64\\bin",
            "C:\\ProgramData\\chocolatey\\lib\\mingw\\tools\\install\\mingw64\\bin",
            "C:\\ProgramData\\chocolatey\\lib\\mingw\\tools\\install\\bin",
            "$env:ChocolateyInstall\\lib\\mingw\\tools\\install\\mingw64\\bin",
            "C:\\tools\\mingw64\\bin"
          )

          $mingwPath = $possiblePaths | Where-Object { Test-Path "$_\\gcc.exe" } | Select-Object -First 1
          if (-not $mingwPath) {
            Write-Host "âŒ MinGW not found â€” checked:`n$($possiblePaths -join "`n")"
            exit 1
          }

          Write-Host "âœ… MinGW detected at $mingwPath"
          $env:Path = "$mingwPath;$($env:SystemRoot)\\system32;$($env:SystemRoot);"
          echo "$mingwPath" >> $env:GITHUB_PATH
          echo "CC=$mingwPath\\gcc.exe" >> $env:GITHUB_ENV
          echo "CXX=$mingwPath\\g++.exe" >> $env:GITHUB_ENV
          echo "GENERATOR=MinGW Makefiles" >> $env:GITHUB_ENV

          & "$mingwPath\\gcc.exe" --version
          & "$mingwPath\\g++.exe" --version

      # ============================================================
      # ğŸ§© Create macOS Toolchain File
      # ============================================================
      - name: ğŸ§© Create macOS Toolchain File
        if: runner.os == 'macOS'
        run: |
          mkdir -p .github/toolchains
          cat <<'EOF' > .github/toolchains/macos-gcc.cmake
          set(CMAKE_SYSTEM_NAME Darwin)
          set(CMAKE_SYSTEM_PROCESSOR arm64)
          set(CMAKE_OSX_ARCHITECTURES "arm64;x86_64")
          if(EXISTS "/opt/homebrew/opt/gcc/bin/gcc-14")
            set(CMAKE_C_COMPILER "/opt/homebrew/opt/gcc/bin/gcc-14")
            set(CMAKE_CXX_COMPILER "/opt/homebrew/opt/g++-14")
          elseif(EXISTS "/usr/local/opt/gcc/bin/gcc-14")
            set(CMAKE_C_COMPILER "/usr/local/opt/gcc/bin/gcc-14")
            set(CMAKE_CXX_COMPILER "/usr/local/opt/gcc/bin/g++-14")
          else()
            set(CMAKE_C_COMPILER "gcc")
            set(CMAKE_CXX_COMPILER "g++")
          endif()
          EOF

      # ============================================================
      # ğŸ—ï¸ Build with Pure GCC
      # ============================================================
      - name: ğŸ—ï¸ Build R3C (Pure GCC)
        shell: bash
        run: |
          set -e
          echo "ğŸ—ï¸ Building on $RUNNER_OS..."
          mkdir -p build
          if [ "$RUNNER_OS" = "Windows" ]; then
            echo "âš™ï¸ Forcing pure MinGW GCC build"
            export PATH="$(cygpath -u "$CC" | xargs dirname):$PATH"
            cmake -B build -G "MinGW Makefiles" \
              -DCMAKE_BUILD_TYPE=Release \
              -DCMAKE_C_COMPILER="$CC" \
              -DCMAKE_CXX_COMPILER="$CXX" \
              -DCMAKE_TRY_COMPILE_TARGET_TYPE=STATIC_LIBRARY \
              -DCMAKE_VERBOSE_MAKEFILE=ON
          elif [ "$RUNNER_OS" = "macOS" ]; then
            echo "âš™ï¸ Using Pure GCC Toolchain for macOS"
            cmake -B build -G "Unix Makefiles" \
              -DCMAKE_BUILD_TYPE=Release \
              -DCMAKE_TOOLCHAIN_FILE=".github/toolchains/macos-gcc.cmake" \
              -DCMAKE_VERBOSE_MAKEFILE=ON
          else
            cmake -B build -DCMAKE_BUILD_TYPE=Release \
              -DCMAKE_C_COMPILER=gcc \
              -DCMAKE_CXX_COMPILER=g++ \
              -DCMAKE_VERBOSE_MAKEFILE=ON
          fi
          cmake --build build --config Release -j$(nproc || sysctl -n hw.ncpu || echo 4) -v
          ls -lah build || true

      # ============================================================
      # ğŸ“¦ Package & Upload Artifacts
      # ============================================================
      - name: ğŸ“¦ Package Artifacts
        shell: bash
        run: |
          mkdir -p dist
          VERSION=$(date +"%Y%m%d")-$(git rev-parse --short HEAD)
          tar -czf dist/r3c-${{ matrix.os }}-${VERSION}.tar.gz -C build .
          sha256sum dist/* > dist/SHA256SUMS.txt
          cat dist/SHA256SUMS.txt

      - name: ğŸ’¾ Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: r3c-${{ matrix.os }}-gcc
          path: dist/
          retention-days: 7

  # ============================================================
  # ğŸ·ï¸ Auto Tag & Release Job
  # ============================================================
  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ§­ Checkout
        uses: actions/checkout@v4

      # âš™ï¸ Git identity ì„¤ì • (í•„ìˆ˜)
      - name: âš™ï¸ Configure Git Identity
        run: |
          git config --global user.name "r3c-foundation-bot"
          git config --global user.email "bot@r3c.foundation"

      - name: ğŸ’¾ Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets

      - name: ğŸ§¾ Generate Funding Report
        shell: bash
        run: |
          mkdir -p reports
          echo "ğŸ“Š **R3C Foundation Funding Report â€” $(date)**" > reports/FUNDING.md
          echo "- GitHub Sponsors: [https://github.com/sponsors/r3c-foundation]" >> reports/FUNDING.md
          echo "- OpenCollective: [https://opencollective.com/r3c-foundation]" >> reports/FUNDING.md
          echo "- LTS Maintenance: 2025 â†’ 2030" >> reports/FUNDING.md

      - name: ğŸ·ï¸ Create Auto Tag
        id: tag
        shell: bash
        run: |
          DATE=$(date +"%Y%m%d")
          HASH=$(git rev-parse --short HEAD)
          TAG="r3c-lts-${DATE}-${HASH}"
          git tag -a "$TAG" -m "ğŸ”– R3C Foundation LTS Auto Tag"
          git push origin "$TAG"
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: ğŸª¶ Generate LTS Badge
        shell: bash
        run: |
          mkdir -p badges
          echo "LTS: 2025â€“2030 âœ…" > badges/LTS_STATUS.txt

      - name: ğŸš€ Publish Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: "R3C Foundation Stable Release (${{ steps.tag.outputs.tag }})"
          body: |
            ğŸŒ **R3C Final LTS Foundation Ecosystem Release**
            âœ… Pure GCC Multi-OS Builds + Auto Tag + Funding Report + LTS Badge
            ğŸ§  Self-Healing Compiler Pipeline | LTSS 2025â€“2030
          files: |
            release-assets/**/*
            reports/FUNDING.md
            badges/LTS_STATUS.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
