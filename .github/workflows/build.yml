name: ğŸ§± R3C Cross-Platform Build & Stable Auto Release

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: ğŸ§© Cross-Platform Build Matrix
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ§© Generate stubs (Cross-Platform)
        shell: bash
        run: |
          echo "ğŸ” Checking for stub generation scripts..."
          if [ -f scripts/generate_stubs.sh ]; then
            echo "âœ… Found Bash script â€” running generate_stubs.sh"
            bash scripts/generate_stubs.sh
          elif [ -f scripts/generate_stubs.ps1 ]; then
            echo "âœ… Found PowerShell script â€” running generate_stubs.ps1"
            pwsh scripts/generate_stubs.ps1
          else
            echo "âš ï¸ No stub generation script found in ./scripts/"
            exit 1
          fi

      - name: ğŸ§± Build project with CMake
        shell: bash
        run: |
          echo "ğŸ—ï¸ Configuring build..."
          cmake -B build -S .
          echo "ğŸ”¨ Compiling..."
          cmake --build build --parallel 4

      - name: ğŸ§ª Verify build artifacts
        shell: bash
        run: |
          echo "ğŸ” Build output:"
          ls -R build || true
          echo "âœ… Build completed successfully."

      - name: ğŸ“¦ Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: r3c-${{ matrix.os }}
          path: |
            build/**/*.exe
            build/**/*.out
            build/**/*.bin
            build/**/*.zip

  release:
    name: ğŸš€ Auto Tag & Stable Release
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ·ï¸ Create Git Tag
        id: tag_step
        run: |
          TAG="auto-stable-v$(date +'%Y%m%d-%H%M%S')"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "$TAG" -m "Auto release $TAG"
          git push origin "$TAG"

      - name: ğŸ“‚ Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: ğŸš€ Create GitHub Release
        id: release_step
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag_step.outputs.tag }}
          name: "R3C Auto Release (${{ steps.tag_step.outputs.tag }})"
          body: |
            ğŸ§± **R3C Cross-Platform Stable Auto Release**
            - Built for **Linux**, **Windows**, and **macOS**
            - Contains only compiled binaries
            - Generated automatically by GitHub Actions
          files: |
            artifacts/**/*.exe
            artifacts/**/*.out
            artifacts/**/*.bin
            artifacts/**/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true  # âœ… ECONNREFUSED ì‹œì—ë„ ì‹¤íŒ¨ë¡œ ì¤‘ë‹¨ë˜ì§€ ì•ŠìŒ

      - name: ğŸ©¹ Retry Release on Failure (if needed)
        if: steps.release_step.outcome != 'success'
        run: |
          echo "âš ï¸ Release failed previously, retrying once..."
          sleep 10
          gh release create "${{ steps.tag_step.outputs.tag }}" artifacts/**/*.zip \
            --title "R3C Auto Release (${{ steps.tag_step.outputs.tag }})" \
            --notes "Retry upload (stabilized connection)"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
