name: üß© R3C Cross-Platform Auto Build & Release (v6.6 LTS)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    name: üß± Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: üß∞ Checkout Repository
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Set up CMake
        uses: jwlawson/actions-setup-cmake@v2
        with:
          cmake-version: "3.28.3"

      - name: üß© Configure
        run: |
          echo "Configuring for $RUNNER_OS..."
          if [[ "$RUNNER_OS" == "Windows" ]]; then
            cmake -B build -S . -G "Visual Studio 17 2022" -A x64 -DCMAKE_BUILD_TYPE=Release
          else
            cmake -B build -S . -DCMAKE_BUILD_TYPE=Release
          fi

      - name: üî® Build
        run: |
          echo "Building R3C CLI..."
          if [[ "$RUNNER_OS" == "Windows" ]]; then
            cmake --build build --config Release --target r3c_cli
          else
            cmake --build build --target r3c_cli -j$(nproc || sysctl -n hw.ncpu)
          fi

      - name: üì¶ Package Artifacts
        run: |
          mkdir -p dist
          if [[ "$RUNNER_OS" == "Windows" ]]; then
            cp build/Release/r3c_cli.exe dist/
            zip -r r3c-windows-latest.zip dist
          elif [[ "$RUNNER_OS" == "macOS" ]]; then
            cp build/r3c_cli dist/
            zip -r r3c-macos-latest.zip dist
          else
            cp build/r3c_cli dist/
            zip -r r3c-linux-latest.zip dist
          fi

      - name: üöÄ Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: r3c-${{ matrix.os }}
          path: |
            r3c-*-latest.zip

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: üßæ Download All Builds
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: üöÄ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: auto-stable-${{ github.run_id }}
          name: R3C Stable Auto Release (${{ github.run_id }})
          files: |
            artifacts/**/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
