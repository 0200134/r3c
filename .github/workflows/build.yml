name: üîñ R3C 3OS Autonomous Stable Release v4 (PAT Fixed)

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '.github/workflows/**'
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: stable-release
  cancel-in-progress: false

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: üß≠ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ‚öôÔ∏è Setup Git user
        run: |
          git config user.name "github-actions"
          git config user.email "actions@users.noreply.github.com"

      - name: üîç Generate release tag
        id: tag
        run: |
          TAG="v$(date +'%y.%m.%d-%H%M')-stable-final-v4"
          echo "TAG=$TAG" >> $GITHUB_ENV
          echo "ü™∂ Tagging release as $TAG"

      - name: üíæ Configure remote with PAT
        run: |
          git remote set-url origin https://x-access-token:${{ secrets.WORKFLOW_PAT }}@github.com/${{ github.repository }}.git

      - name: ü™∂ Create and push tag using PAT
        run: |
          git tag -a "${TAG}" -m "Stable Final v4"
          git push origin "${TAG}"

      - name: üîç Check release assets
        run: |
          if [ -z "$(ls **/r3c-*.tar.gz 2>/dev/null)" ]; then
            echo "‚ùå No build artifacts found."
            exit 1
          fi

      - name: üß± Create GitHub Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.WORKFLOW_PAT }}
        with:
          tag_name: ${{ env.TAG }}
          name: "R3C ${TAG} (Auto Stable Release)"
          body: |
            üß± R3C 3OS Auto Release Log
            Date: $(date -u)
            Verified across Ubuntu/macOS/Windows
          files: |
            **/r3c-*.tar.gz
            SHA256SUMS.txt

      - name: üß© Verify Release Creation
        run: |
          if ! gh release view "${TAG}" >/dev/null 2>&1; then
            echo "‚ùå Release creation failed!"
            exit 1
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.WORKFLOW_PAT }}

      - name: ‚úÖ Done
        run: echo "Stable Release complete ‚úÖ"
