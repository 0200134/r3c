name: ðŸ”– R3C v8.1 â€” Pure GCC 3OS Autonomous Release (LTSS + Integrity)

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '.github/workflows/**'
  schedule:
    - cron: "0 0 * * *"  # ë§¤ì¼ 00:00 UTC ìžë™ ë¹Œë“œ
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: pure-gcc-stable
  cancel-in-progress: false

jobs:
  build:
    name: "ðŸ”§ Pure GCC 3OS Build"
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      # ==========================================================
      # ðŸ§­ Checkout Repository
      # ==========================================================
      - name: ðŸ§­ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ==========================================================
      # âš™ï¸ Setup Pure GCC Environment
      # ==========================================================
      - name: âš™ï¸ Setup Pure GCC Environment
        shell: bash
        run: |
          echo "ðŸ”§ Setting up GCC on ${{ matrix.os }}..."

          if [[ "$RUNNER_OS" == "Windows" ]]; then
            echo "ðŸªŸ Installing MinGW (GCC)..."
            choco install mingw -y
            export PATH="/c/tools/mingw64/bin:/c/ProgramData/chocolatey/bin:$PATH"
            which gcc || { echo "âŒ GCC not found!"; exit 1; }
            rm -rf "/c/Program Files/Microsoft Visual Studio" || true
            rm -rf "/c/Program Files (x86)/Microsoft Visual Studio" || true
            echo "âœ… MSVC removed. Pure GCC only."

          elif [[ "$RUNNER_OS" == "macOS" ]]; then
            echo "ðŸŽ Installing Homebrew GCC..."
            brew update
            brew install gcc || true
            ln -sf "$(brew --prefix)/bin/gcc-13" /usr/local/bin/gcc
            ln -sf "$(brew --prefix)/bin/g++-13" /usr/local/bin/g++
            export CC=gcc
            export CXX=g++
            gcc --version
            echo "âœ… macOS Pure GCC environment ready."

          elif [[ "$RUNNER_OS" == "Linux" ]]; then
            echo "ðŸ§ Installing GCC..."
            sudo apt-get update -y
            sudo apt-get install -y build-essential
            gcc --version
            echo "âœ… Linux GCC OK"
          fi

      # ==========================================================
      # ðŸ§± Build R3C (Pure GCC)
      # ==========================================================
      - name: ðŸ§± Build R3C (Pure GCC)
        shell: bash
        run: |
          echo "ðŸ—ï¸ Building R3C..."
          mkdir -p build
          cmake -E env CC=gcc CXX=g++ cmake -B build -DCMAKE_BUILD_TYPE=Release -G "Unix Makefiles"
          cmake --build build --target r3c_cli
          ls -lah build

      # ==========================================================
      # ðŸ”Ž Smoke Test
      # ==========================================================
      - name: ðŸ”Ž Smoke Test
        shell: bash
        run: |
          exe=$(find build -type f -name "r3c_cli*" | head -n1)
          if [ -n "$exe" ]; then
            echo "âœ… Found binary: $exe"
            "$exe" --version || echo "âš ï¸ CLI version test skipped."
          else
            echo "âŒ r3c_cli not found!"
            exit 1
          fi

      # ==========================================================
      # ðŸ“¦ Package
      # ==========================================================
      - name: ðŸ“¦ Package Build
        shell: bash
        run: |
          mkdir -p dist
          tar -czf "dist/r3c-${{ matrix.os }}.tar.gz" -C build .
          echo "âœ… Packaged build for ${{ matrix.os }}"

      # ==========================================================
      # ðŸ’¾ Upload
      # ==========================================================
      - name: ðŸ’¾ Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: r3c-${{ matrix.os }}
          path: dist/
          retention-days: 7

  # ==============================================================
  # ðŸ“Š Unified Release (Optional)
  # ==============================================================
  release:
    name: "ðŸ“Š Pure GCC Release Publish"
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: ðŸ§­ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¥ Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: release_dist

      - name: ðŸ§® Combine Hashes
        run: |
          find release_dist -type f -name "*.tar.gz" -exec sha256sum {} + > release_dist/SHA256SUMS.txt
          cat release_dist/SHA256SUMS.txt

      - name: ðŸª¶ Generate tag
        run: |
          TAG="v$(date -u +'%y.%m.%d-%H%M')-pure-gcc-stable-v8.1"
          echo "TAG=$TAG" >> $GITHUB_ENV
          echo "Generated tag: $TAG"

      - name: ðŸ§± Publish GitHub Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.WORKFLOW_PAT }}
        with:
          tag_name: ${{ env.TAG }}
          name: "R3C ${{ env.TAG }} (Pure GCC 3OS Stable)"
          body: |
            ### R3C v8.1 â€” Pure GCC Autonomous Stable Build
            âœ… Verified 3OS Build (No LLVM / No Clang / No MSVC)
            ðŸ§­ GCC-only Sovereign Toolchain
            ðŸ“¦ SHA256 Checksums:
            ```
            $(cat release_dist/SHA256SUMS.txt)
            ```
          files: |
            release_dist/**/*.tar.gz
            release_dist/SHA256SUMS.txt
