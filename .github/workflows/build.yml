name: ðŸ§© R3C Cross-Platform Build (v2)

on:
  push:
  pull_request:

jobs:
  build:
    name: ðŸ§± Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    defaults:
      run:
        shell: bash

    steps:
      - name: ðŸ§° Checkout repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Set up CMake
        uses: jwlawson/actions-setup-cmake@v2
        with:
          cmake-version: "3.28.3"

      - name: ðŸ§© Configure build
        run: |
          echo "âš™ï¸ Configuring for $RUNNER_OS..."
          if [[ "$RUNNER_OS" == "Windows" ]]; then
            cmake -B build -S . -G "Visual Studio 17 2022" -A x64 -DCMAKE_BUILD_TYPE=Release
          else
            cmake -B build -S . -DCMAKE_BUILD_TYPE=Release
          fi

      - name: ðŸ”§ Fix permissions (macOS/Linux)
        if: runner.os != 'Windows'
        run: chmod +x scripts/generate_stubs.sh || true

      - name: ðŸš€ Build (Auto Retry up to 3 times)
        run: |
          echo "âš™ï¸ Building on $RUNNER_OS..."
          attempt=1
          while [ $attempt -le 3 ]; do
            echo "ðŸ” Attempt $attempt..."
            if [[ "$RUNNER_OS" == "Windows" ]]; then
              echo "ðŸªŸ Using CMake --parallel"
              cmake --build build --config Release --parallel 4 > build_log.txt 2>&1
            else
              echo "ðŸ§ Using Make/Ninja -j4"
              cmake --build build --config Release -- -j4 > build_log.txt 2>&1
            fi

            if [ $? -eq 0 ]; then
              echo "âœ… Build success"
              tail -n 10 build_log.txt
              echo "success=true" >> $GITHUB_OUTPUT
              exit 0
            else
              echo "âš ï¸ Build failed attempt $attempt"
              tail -n 20 build_log.txt
              ((attempt++))
            fi
          done
          echo "âŒ Build failed after 3 attempts"
          cat build_log.txt || true
          echo "success=false" >> $GITHUB_OUTPUT
          exit 1

      - name: ðŸ§¾ Show CMake error logs
        if: failure()
        run: |
          echo "===== CMake Error Log ====="
          cat build/CMakeFiles/CMakeError.log || true
          echo "===== CMake Output Log ====="
          cat build/CMakeFiles/CMakeOutput.log || true

      - name: ðŸ“¦ Upload build logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build_logs_${{ matrix.os }}
          path: |
            build_log.txt
            build/CMakeFiles/CMakeError.log
            build/CMakeFiles/CMakeOutput.log
