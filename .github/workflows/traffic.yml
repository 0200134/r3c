# =========================================================
# 📊 .github/workflows/traffic.yml (v2.0)
# R3C GitHub Traffic Logger — Official API Version
# =========================================================

name: 📊 R3C Traffic Logger (v2.0)

on:
  schedule:
    - cron: '0 0 * * 0' # 매주 일요일 00시 UTC 실행
  workflow_dispatch:

permissions:
  contents: write

jobs:
  traffic:
    name: Collect GitHub Traffic Data
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v4

      - name: 📊 Fetch Traffic via GitHub API
        id: traffic
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const repo = {
              owner: context.repo.owner,
              repo: context.repo.repo
            };

            const views = await github.repos.getViews(repo);
            const clones = await github.repos.getClones(repo);

            const summary = {
              timestamp: new Date().toISOString(),
              repo: `${repo.owner}/${repo.repo}`,
              views_total: views.data.count,
              unique_visitors: views.data.uniques,
              clones_total: clones.data.count,
              unique_cloners: clones.data.uniques
            };

            console.log("📊 Traffic Summary:", summary);

            const fs = require('fs');
            fs.mkdirSync('traffic', { recursive: true });
            fs.writeFileSync('traffic/traffic.json', JSON.stringify(summary, null, 2));

            core.setOutput('views', views.data.count);
            core.setOutput('clones', clones.data.count);
            core.setOutput('visitors', views.data.uniques);
            core.setOutput('cloners', clones.data.uniques);

      - name: 🧾 Append Traffic to Log
        run: |
          echo "=====================================================" >> traffic/traffic_log.txt
          echo "📅 $(date -u)" >> traffic/traffic_log.txt
          echo "🌐 Views Total: ${{ steps.traffic.outputs.views }}" >> traffic/traffic_log.txt
          echo "👥 Unique Visitors: ${{ steps.traffic.outputs.visitors }}" >> traffic/traffic_log.txt
          echo "📦 Clones Total: ${{ steps.traffic.outputs.clones }}" >> traffic/traffic_log.txt
          echo "🧩 Unique Cloners: ${{ steps.traffic.outputs.cloners }}" >> traffic/traffic_log.txt
          echo "=====================================================" >> traffic/traffic_log.txt

      - name: 💾 Commit & Push Traffic Data
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "r3c-bot"
          git config user.email "r3c-bot@users.noreply.github.com"
          git add traffic/traffic.json traffic/traffic_log.txt
          git commit -m "📊 update traffic stats ($(date -u +'%Y-%m-%d'))" || echo "⚠️ No changes to commit."
          git push origin HEAD:${{ github.ref }} || echo "⚠️ Push skipped."
