name: 📊 R3C Traffic Analytics

on:
  # ✅ main 브랜치에 push될 때마다 자동 실행
  push:
    branches: [ main ]
  # ✅ 수동 실행 버튼도 유지
  workflow_dispatch:
  # ✅ 매일 UTC 00:00 (한국시간 오전 9시)에 자동 실행
  schedule:
    - cron: "0 0 * * *"

jobs:
  generate-traffic-chart:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Python + deps
        run: |
          sudo apt-get update -y
          sudo apt-get install -y python3 python3-pip
          pip install matplotlib requests pandas

      - name: Generate traffic chart
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python3 <<'EOF'
import requests, matplotlib.pyplot as plt, pandas as pd, os

repo = "${{ github.repository }}"
headers = {"Authorization": f"token {os.environ['GITHUB_TOKEN']}"}

views = requests.get(f"https://api.github.com/repos/{repo}/traffic/views", headers=headers).json()
clones = requests.get(f"https://api.github.com/repos/{repo}/traffic/clones", headers=headers).json()

view_data = pd.DataFrame(views.get("views", []))
clone_data = pd.DataFrame(clones.get("clones", []))

if not view_data.empty and not clone_data.empty:
    plt.figure(figsize=(8,4))
    plt.plot(view_data["timestamp"], view_data["count"], marker='o', label="Views", color='tab:blue')
    plt.plot(clone_data["timestamp"], clone_data["count"], marker='s', label="Clones", color='tab:orange')
    plt.title("R3C GitHub Traffic (Views / Clones)")
    plt.xlabel("Date")
    plt.ylabel("Count")
    plt.legend()
    plt.grid(True)
    plt.tight_layout()
    plt.savefig("traffic_chart.png")
    print("✅ Generated traffic_chart.png")
else:
    print("⚠️ No traffic data found (API empty). Try again tomorrow.")
EOF

      - name: Commit and push chart
        run: |
          git config user.name "r3c-bot"
          git config user.email "bot@r3c.local"
          git add traffic_chart.png || true
          git commit -m "📈 auto: update traffic chart" || echo "No new data to commit"
          git push || echo "No push needed"
