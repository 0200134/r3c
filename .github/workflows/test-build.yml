name: R3C Cross-Platform Build & Release (Self-Healing + Report)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    outputs:
      duration_sec: ${{ steps.metrics.outputs.duration_sec }}
      commit_msg: ${{ steps.metrics.outputs.commit_msg }}
      commit_sha: ${{ steps.metrics.outputs.commit_sha }}

    steps:
      # 0) ì‹œì‘ íƒ€ì„ìŠ¤íƒ¬í”„
      - name: Mark start time
        id: start
        run: echo "START_TS=$(date +%s)" >> "$GITHUB_ENV"

      # 1) ì²´í¬ì•„ì›ƒ
      - name: Checkout
        uses: actions/checkout@v4

      # 2) ë”ë¯¸ í…ŒìŠ¤íŠ¸ í™•ë³´ (CMake ì‹¤íŒ¨ ë°©ì§€)
      - name: Ensure dummy test exists
        shell: bash
        run: |
          mkdir -p tests
          if [ ! -f "tests/test_basic.cpp" ]; then
            cat > tests/test_basic.cpp <<'CPP'
#include <iostream>
int main(){ std::cout << "[r3c_tests] dummy test passed\n"; return 0; }
CPP
            echo "âœ… created tests/test_basic.cpp"
          else
            echo "âœ… found tests/test_basic.cpp"
          fi

      # 3) ì˜ì¡´ì„±
      - name: Install deps (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake nasm g++ nlohmann-json3-dev

      - name: Install deps (macOS)  # brew ì‹¤íŒ¨í•´ë„ ê³„ì†
        if: runner.os == 'macOS'
        run: |
          brew install cmake nasm || true
          mkdir -p include/nlohmann
          curl -fsSL https://raw.githubusercontent.com/nlohmann/json/develop/single_include/nlohmann/json.hpp \
            -o include/nlohmann/json.hpp
          echo "âœ… json.hpp ready (macOS)"

      - name: Install deps (Windows)
        if: runner.os == 'Windows'
        run: |
          choco install nasm -y
          choco install cmake --installargs 'ADD_CMAKE_TO_PATH=System' -y
          mkdir -p include\nlohmann
          curl -fsSL https://raw.githubusercontent.com/nlohmann/json/develop/single_include/nlohmann/json.hpp ^
            -o include\nlohmann\json.hpp
          echo "âœ… json.hpp ready (Windows)"

      # 4) CMake ì„¤ì • (+ ë¡œì»¬ include ê°•ì œ)
      - name: Configure
        run: cmake -B build -S . -DCMAKE_CXX_FLAGS="-Iinclude"

      # 5) ë¹Œë“œ (ìê°€ë³µêµ¬)
      - name: Build (self-healing)
        shell: bash
        run: |
          set +e
          cmake --build build --config Release -- -j4
          rc=$?
          if [ $rc -ne 0 ]; then
            echo "âš ï¸ first build failed, repairing..."
            mkdir -p include/nlohmann
            curl -fsSL https://raw.githubusercontent.com/nlohmann/json/develop/single_include/nlohmann/json.hpp \
              -o include/nlohmann/json.hpp
            cmake -B build -S . -DCMAKE_CXX_FLAGS="-Iinclude"
            cmake --build build --config Release -- -j2
            rc=$?
          fi
          exit $rc

      # 6) (ì„ íƒ) í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      - name: Run tests
        shell: bash
        run: |
          if [ -f "build/bin/r3c_tests" ]; then
            ./build/bin/r3c_tests
          else
            echo "âš ï¸ no test target, skip"
          fi

      # 7) ë¬¸ì„œ ë¬¶ê¸° (README, r3c_spec.md ìˆìœ¼ë©´ í¬í•¨)
      - name: Prepare docs bundle
        shell: bash
        run: |
          mkdir -p dist/docs
          [ -f README.md ] && cp README.md dist/docs/ || true
          [ -f r3c_spec.md ] && cp r3c_spec.md dist/docs/ || true
          [ -d docs ] && cp -r docs/* dist/docs/ || true
          echo "# R3C Build Docs" > dist/docs/_bundle_index.md
          echo "- README.md" >> dist/docs/_bundle_index.md
          echo "- r3c_spec.md (if present)" >> dist/docs/_bundle_index.md

      # 8) ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ (OSë³„)
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: r3c-${{ matrix.os }}
          path: |
            build/bin/r3c*
            dist/docs/**
            !**/*.pdb

      # 9) ë©”íŠ¸ë¦­(ë¹Œë“œì‹œê°„/ì»¤ë°‹ë©”ì‹œì§€)
      - name: Capture metrics
        id: metrics
        shell: bash
        run: |
          END_TS=$(date +%s)
          DUR=$(( END_TS - START_TS ))
          echo "duration_sec=${DUR}" >> "$GITHUB_OUTPUT"
          # ìµœê·¼ ì»¤ë°‹
          MSG="$(git log -1 --pretty=%s)"
          SHA="$(git rev-parse --short HEAD)"
          echo "commit_msg=${MSG}" >> "$GITHUB_OUTPUT"
          echo "commit_sha=${SHA}" >> "$GITHUB_OUTPUT"

  release:
    name: Release & Comment
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: release_artifacts

      - name: Zip per OS (with date & run#)
        id: pack
        run: |
          cd release_artifacts
          DATE=$(date +%Y-%m-%d)
          for d in */; do
            base="${d%/}"
            zip -qr "${base}-${DATE}-v${{ github.run_number }}.zip" "$d"
          done
          echo "date=${DATE}" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        id: rel
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ github.run_number }}"
          name: "R3C Build #${{ github.run_number }}"
          body: |
            ğŸš€ **R3C Cross-Platform Build Completed**
            âœ… Ubuntu Â· macOS Â· Windows
            ğŸ§© NASM + nlohmann/json + CMake
            ğŸ“¦ Docs bundled (README / r3c_spec.md if exists)
            ğŸ•’ Build time (sec): ${{ needs.build.outputs.duration_sec }}
            ğŸ’¬ Commit: `${{ needs.build.outputs.commit_sha }}` â€” ${{ needs.build.outputs.commit_msg }}
          files: release_artifacts/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # PR ì´ë²¤íŠ¸ë©´ PR ì½”ë©˜íŠ¸, pushë©´ ì»¤ë°‹ ì½”ë©˜íŠ¸
      - name: PR comment (if PR)
        if: github.event_name == 'pull_request'
        uses: peter-evans/create-or-update-comment@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            âœ… **R3C Build #${{ github.run_number }} ì„±ê³µ**
            ğŸ•’ ì†Œìš”: ${{ needs.build.outputs.duration_sec }}ì´ˆ
            ğŸ’¬ ì»¤ë°‹: `${{ needs.build.outputs.commit_sha }}` â€” ${{ needs.build.outputs.commit_msg }}
            ğŸ”— ë¦´ë¦¬ìŠ¤: ${{ steps.rel.outputs.html_url }}

      - name: Commit comment (if push)
        if: github.event_name == 'push'
        uses: peter-evans/commit-comment@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit: ${{ github.sha }}
          body: |
            âœ… **R3C Build #${{ github.run_number }} ì„±ê³µ**
            ğŸ•’ ì†Œìš”: ${{ needs.build.outputs.duration_sec }}ì´ˆ
            ğŸ’¬ ì»¤ë°‹: `${{ needs.build.outputs.commit_sha }}` â€” ${{ needs.build.outputs.commit_msg }}
            ğŸ”— ë¦´ë¦¬ìŠ¤: ${{ steps.rel.outputs.html_url }}
