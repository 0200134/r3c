name: R3C Self-Diagnosis & Status Dashboard

on:
  push:
    branches: [ "*" ]
  pull_request:
    branches: [ "*" ]
  workflow_dispatch:

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      # âœ… 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout
        uses: actions/checkout@v4

      # âœ… 2. json.hpp í™•ë³´
      - name: Ensure nlohmann/json.hpp exists
        shell: bash
        run: |
          mkdir -p include/nlohmann
          curl -fsSL https://raw.githubusercontent.com/nlohmann/json/develop/single_include/nlohmann/json.hpp \
            -o include/nlohmann/json.hpp
          echo "âœ… nlohmann/json.hpp ready."

      # âœ… 3. ë¹Œë“œ íˆ´ ì„¤ì¹˜
      - name: Prepare Build Tools
        run: |
          if [ "$RUNNER_OS" = "Linux" ]; then
            sudo apt-get update
            sudo apt-get install -y cmake nasm
          elif [ "$RUNNER_OS" = "macOS" ]; then
            brew install cmake nasm || true
          elif [ "$RUNNER_OS" = "Windows" ]; then
            choco install cmake --installargs 'ADD_CMAKE_TO_PATH=System' -y
            choco install nasm -y
          fi
          echo "âœ… Tools ready."

      # âœ… 4. Configure
      - name: Configure CMake
        run: cmake -B build -S . -DCMAKE_CXX_FLAGS="-Iinclude"

      # âš™ï¸ 5. Build (ì—ëŸ¬ ë¬´ì‹œ, ë¡œê·¸ ë‚¨ê¹€)
      - name: Build Project
        id: build_step
        shell: bash
        continue-on-error: true
        run: |
          echo "âš™ï¸ Building on $RUNNER_OS ..."
          set +e
          cmake --build build --config Release -- -j4 > build_log.txt 2>&1
          status=$?
          tail -n 40 build_log.txt
          echo "exit_code=$status" >> $GITHUB_OUTPUT
          exit $status

      # ğŸš¨ 6. ì‹¤íŒ¨ ë³´ê³  + ìë™ í•´ê²° ì œì•ˆ
      - name: Create issue on failure
        if: failure()
        uses: peter-evans/create-issue-from-file@v4
        with:
          title: "âŒ Build failed on ${{ matrix.os }}"
          content-filepath: build_log.txt
          labels: |
            build
            ci
            auto-report
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Suggest Fix on Failure
        if: failure()
        uses: peter-evans/create-or-update-comment@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ğŸ§© **R3C Auto-Diagnosis Suggestion**
            Build failed on **${{ matrix.os }}**.

            **Detected Problems & Possible Fixes:**
            - `'nlohmann/json.hpp' not found` â†’ Ensure include step before CMake.
            - `ld: symbol(s) not found` â†’ Missing source (e.g., pipeline.cpp, test_main).
            - `permission denied` â†’ Check script execute bits (`chmod +x`).
            - `link.exe not found` â†’ Install Visual Studio Build Tools or set PATH.

            ğŸ§  CI Bot detected failure pattern and suggested remedies.
            The full build log was uploaded automatically.

      # ğŸŸ¢ 7. ì„±ê³µ ì‹œ ì¶•í•˜ ì½”ë©˜íŠ¸ + ìƒíƒœ ë°°ì§€
      - name: Comment on success
        if: success()
        uses: peter-evans/create-or-update-comment@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ğŸŸ¢ **R3C Build Successful on ${{ matrix.os }}!**
            Everything compiled and linked without errors ğŸ‰  

            | OS | Status | Badge |
            |----|---------|-------|
            | Ubuntu | âœ… Passed | ![Ubuntu](https://img.shields.io/badge/build-passed-brightgreen?logo=ubuntu) |
            | macOS | âœ… Passed | ![macOS](https://img.shields.io/badge/build-passed-brightgreen?logo=apple) |
            | Windows | âœ… Passed | ![Windows](https://img.shields.io/badge/build-passed-brightgreen?logo=windows) |

            âœ… Artifacts uploaded under `r3c-${{ matrix.os }}`.

      # ğŸ“¦ 8. ë¹Œë“œ ë¡œê·¸ / ê²°ê³¼ ì—…ë¡œë“œ
      - name: Upload logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: r3c-build-log-${{ matrix.os }}
          path: build_log.txt

      - name: Upload artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: r3c-${{ matrix.os }}
          path: |
            build/bin/r3c*
            !**/*.pdb
