# =========================================================
# ðŸ” .github/workflows/self-fix.yml (v3.5.1)
# R3C Self-Healing Automation â€” Cross-Platform Full Stable Edition
# =========================================================

name: "ðŸ” R3C Self-Fix Automation (v3.5.1)"

on:
  push:
    branches:
      - '**'
  pull_request:
    types: [opened, synchronize]
  workflow_dispatch:

permissions:
  contents: write
  issues: write

defaults:
  run:
    working-directory: ${{ github.workspace }}

jobs:
  self-fix:
    name: Self-Fix on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ§° Setup CMake
        uses: jwlawson/actions-setup-cmake@v1

      - name: âš™ï¸ Configure project
        shell: bash
        run: |
          echo "ðŸ§¹ Cleaning build directory..."
          rm -rf build
          echo "ðŸ› ï¸ Running CMake configure..."
          export CMAKE_POLICY_VERSION_MINIMUM=3.5
          cmake -B build -S $GITHUB_WORKSPACE | tee build_log.txt

      - name: ðŸ§© Build project
        id: build
        shell: bash
        continue-on-error: true
        run: |
          echo "ðŸ”¨ Building..."
          export CMAKE_POLICY_VERSION_MINIMUM=3.5
          cmake --build build --config Release -j4 | tee -a build_log.txt

      - name: ðŸ§  Auto-fix missing headers or stubs
        if: ${{ steps.build.outcome == 'failure' }}
        shell: pwsh
        run: |
          Write-Host "âš ï¸ Build failed â€” applying stub fix and cmake patch..."
          New-Item -ItemType Directory -Force -Path "include/nlohmann" | Out-Null
          New-Item -ItemType Directory -Force -Path "src" | Out-Null
          if (Test-Path "build/_deps/nlohmann_json-src/CMakeLists.txt") {
            (Get-Content "build/_deps/nlohmann_json-src/CMakeLists.txt") -replace 'cmake_minimum_required\(VERSION [0-9.]+\)', 'cmake_minimum_required(VERSION 3.5)' | Set-Content "build/_deps/nlohmann_json-src/CMakeLists.txt"
            Write-Host "âœ… Patched nlohmann_json CMakeLists.txt to version 3.5"
          }
          Set-Content -Path "include/nlohmann/json.hpp" -Value "// ðŸ©¹ Auto-generated stub for missing json.hpp"
          Set-Content -Path "src/r3c_stub.cpp" -Value "// ðŸ©¹ Auto-generated stub for r3c_stub.cpp"
          Write-Host "âœ… Stubs regenerated."
          Add-Content -Path "build_log.txt" -Value "ðŸ§  Self-fix: stub + cmake patch applied"

      - name: ðŸ” Rebuild after fix
        if: ${{ steps.build.outcome == 'failure' }}
        shell: bash
        run: |
          echo "ðŸ”„ Rebuilding after self-fix..." | tee -a build_log.txt
          export CMAKE_POLICY_VERSION_MINIMUM=3.5
          cmake -B build -S $GITHUB_WORKSPACE | tee -a build_log.txt
          cmake --build build --config Release -j4 | tee -a build_log.txt || echo "âš ï¸ Build still failing." | tee -a build_log.txt

      - name: ðŸ“¤ Commit & Push auto-fix
        if: ${{ steps.build.outcome == 'failure' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          git config user.name "r3c-bot"
          git config user.email "r3c-bot@users.noreply.github.com"
          git add include/nlohmann/json.hpp src/r3c_stub.cpp build/_deps/nlohmann_json-src/CMakeLists.txt || true
          git commit -m "ðŸ©¹ self-fix: cmake policy + stub regeneration (v3.5.1)" || true
          git push origin HEAD:${{ github.ref }} --no-tags || echo "âš ï¸ Push skipped (no permission or tag conflict)."

      - name: ðŸª„ Create issue from build log
        if: ${{ steps.build.outcome == 'failure' }}
        uses: peter-evans/create-issue-from-file@v4
        with:
          title: "âŒ Build failed on ${{ runner.os }} â€” Auto-Fix Attempted"
          content-filepath: build_log.txt
          labels: |
            auto-fix
            ci-failure

      - name: ðŸ§¾ Self-Fix Summary
        shell: bash
        run: |
          echo "=====================================================" >> build_log.txt
          echo "R3C Self-Fix Summary (v3.5.1)" >> build_log.txt
          echo "=====================================================" >> build_log.txt
          if [ '${{ steps.build.outcome }}' = 'failure' ]; then
            echo "ðŸ§© Self-fix applied (stub + cmake + mkdir patched)." >> build_log.txt
          else
            echo "âœ… Build succeeded â€” no fix needed." >> build_log.txt
          fi
          cat build_log.txt
