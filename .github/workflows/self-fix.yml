name: 🔁 R3C Self-Fix Automation (v2)

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:
    types: [ opened, synchronize ]

# ✅ 이 부분이 핵심 — GitHub Token 권한 설정
permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  self-fix:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      # =====================================================
      # 1️⃣ Checkout & Setup
      # =====================================================
      - name: 📥 Checkout repository
        uses: actions/checkout@v4

      - name: 🧰 Setup CMake
        uses: jwlawson/actions-setup-cmake@v1

      # =====================================================
      # 2️⃣ Build (cross-platform)
      # =====================================================
      - name: ⚙️ Configure project
        shell: bash
        run: cmake -B build -S . > build_log.txt 2>&1

      - name: 🧩 Build project
        id: build
        shell: bash
        continue-on-error: true
        run: cmake --build build -j4 >> build_log.txt 2>&1

      # =====================================================
      # 3️⃣ Self-Fix (auto repair)
      # =====================================================
      - name: 🧠 Analyze and auto-fix build issues
        if: ${{ steps.build.outcome == 'failure' }}
        shell: bash
        run: |
          echo "⚠️ Build failed — attempting self-repair..."
          mkdir -p include/nlohmann
          mkdir -p src
          echo "// 🩹 Auto-generated stub for missing json.hpp" > include/nlohmann/json.hpp
          echo "// 🩹 Auto-generated stub for r3c_stub.cpp" > src/r3c_stub.cpp
          echo "✅ Stubs regenerated." >> build_log.txt

      - name: 🔁 Rebuild after fix
        if: ${{ steps.build.outcome == 'failure' }}
        shell: bash
        run: |
          echo "🔄 Rebuilding after self-fix..." >> build_log.txt
          cmake -B build -S . >> build_log.txt 2>&1
          cmake --build build -j4 >> build_log.txt 2>&1 || echo "⚠️ Build still failing after fix." >> build_log.txt

      # =====================================================
      # 4️⃣ Commit & Push Fix (only if fix applied)
      # =====================================================
      - name: 📤 Commit & Push auto-fix
        if: ${{ steps.build.outcome == 'failure' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          git config user.name "r3c-bot"
          git config user.email "r3c-bot@users.noreply.github.com"
          git add include/nlohmann/json.hpp src/r3c_stub.cpp || true
          git commit -m "🩹 self-fix: regenerated missing files" || true
          git push origin HEAD:${{ github.ref }} || echo "⚠️ Push skipped (no permission)."

      # =====================================================
      # 5️⃣ Create issue when build fails (logs included)
      # =====================================================
      - name: 🪄 Create issue from build log
        if: ${{ steps.build.outcome == 'failure' }}
        uses: peter-evans/create-issue-from-file@v4
        with:
          title: "❌ Build failed on ${{ runner.os }} — Auto-Fix Attempted"
          content-filepath: build_log.txt
          labels: |
            auto-fix
            ci-failure

      # =====================================================
      # 6️⃣ Add summary to Actions tab
      # =====================================================
      - name: 🧾 Summary
        shell: bash
        run: |
          echo "=====================================================" >> build_log.txt
          echo "R3C Self-Fix Summary" >> build_log.txt
          echo "=====================================================" >> build_log.txt
          if [ '${{ steps.build.outcome }}' = 'failure' ]; then
            echo "🧩 Self-fix applied (stub regenerated)." >> build_log.txt
          else
            echo "✅ Build succeeded — no fix needed." >> build_log.txt
          fi
          cat build_log.txt
