name: ðŸ” R3C Self-Fix Automation (v3 Safe)

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:
    types: [ opened, synchronize ]

jobs:
  self-fix:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      # =====================================================
      # 1ï¸âƒ£ Checkout & Setup
      # =====================================================
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ§° Setup CMake
        uses: jwlawson/actions-setup-cmake@v1

      # =====================================================
      # 2ï¸âƒ£ Build
      # =====================================================
      - name: âš™ï¸ Configure project
        shell: bash
        run: cmake -B build -S . > build_log.txt 2>&1

      - name: ðŸ§© Build project
        id: build
        shell: bash
        continue-on-error: true
        run: cmake --build build -j4 >> build_log.txt 2>&1

      # =====================================================
      # 3ï¸âƒ£ Self-Fix (safe conditional mode)
      # =====================================================
      - name: ðŸ§  Conditional self-repair
        if: ${{ steps.build.outcome == 'failure' }}
        shell: bash
        run: |
          echo "âš ï¸ Build failed â€” analyzing repair conditions..." >> build_log.txt
          mkdir -p include/nlohmann
          mkdir -p src
          # json.hpp ì—†ëŠ” ê²½ìš°ë§Œ ìƒì„±
          if [ ! -f include/nlohmann/json.hpp ]; then
            echo "// ðŸ©¹ Auto-generated stub for missing json.hpp" > include/nlohmann/json.hpp
            echo "âœ… json.hpp stub generated" >> build_log.txt
          fi
          # r3c_stub.cppëŠ” transpiler.cpp ì—†ì„ ë•Œë§Œ ìƒì„±
          if [ ! -f src/transpiler.cpp ]; then
            echo "// ðŸ©¹ Auto-generated stub for missing transpiler.cpp" > src/r3c_stub.cpp
            echo "âœ… transpiler stub generated" >> build_log.txt
          else
            echo "âœ… Real transpiler.cpp exists, skipping stub regen" >> build_log.txt
          fi

      # =====================================================
      # 4ï¸âƒ£ Rebuild after conditional fix
      # =====================================================
      - name: ðŸ” Rebuild after conditional fix
        if: ${{ steps.build.outcome == 'failure' }}
        shell: bash
        run: |
          echo "ðŸ”„ Rebuilding after conditional self-fix..." >> build_log.txt
          cmake -B build -S . >> build_log.txt 2>&1
          cmake --build build -j4 >> build_log.txt 2>&1 || echo "âš ï¸ Still failing after fix" >> build_log.txt

      # =====================================================
      # 5ï¸âƒ£ CMake sanity check â€” ensure all sources included
      # =====================================================
      - name: ðŸ§© Ensure all sources included
        shell: bash
        run: |
          echo "Verifying that transpiler.cpp and pipeline.cpp are part of build..."
          grep -q "transpiler.cpp" CMakeLists.txt || echo "âš ï¸ transpiler.cpp not found in CMakeLists.txt" >> build_log.txt
          grep -q "pipeline.cpp" CMakeLists.txt || echo "âš ï¸ pipeline.cpp not found in CMakeLists.txt" >> build_log.txt

      # =====================================================
      # 6ï¸âƒ£ Commit & Push Fix (optional)
      # =====================================================
      - name: ðŸ“¤ Commit & Push auto-fix
        if: ${{ steps.build.outcome == 'failure' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          git config user.name "r3c-bot"
          git config user.email "r3c-bot@users.noreply.github.com"
          git add include/nlohmann/json.hpp src/r3c_stub.cpp || true
          git commit -m "ðŸ©¹ self-fix: conditional stub regeneration (safe mode)" || true
          git push origin HEAD:${{ github.ref }} || echo "âš ï¸ Push skipped (no permission)" >> build_log.txt

      # =====================================================
      # 7ï¸âƒ£ Create issue if still fails
      # =====================================================
      - name: ðŸª„ Create issue from build log
        if: ${{ steps.build.outcome == 'failure' }}
        uses: peter-evans/create-issue-from-file@v4
        with:
          title: "âŒ Build failed on ${{ runner.os }} â€” Safe Self-Fix Attempted"
          content-filepath: build_log.txt
          labels: |
            auto-fix
            ci-failure

      # =====================================================
      # 8ï¸âƒ£ Summary
      # =====================================================
      - name: ðŸ§¾ Summary
        shell: bash
        run: |
          echo "=====================================================" >> build_log.txt
          echo "R3C Self-Fix (Safe Mode) Summary" >> build_log.txt
          echo "=====================================================" >> build_log.txt
          cat build_log.txt
