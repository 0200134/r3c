name: ðŸ§  R3C Self-Fix & Auto-Rebuild (Tested Autonomous)

on:
  # âœ… ìˆ˜ë™ ì‹¤í–‰ìš© ë²„íŠ¼
  workflow_dispatch:

  # âœ… main ë¸Œëžœì¹˜ í‘¸ì‹œ ì‹œ ìžë™ ì‹¤í–‰
  push:
    branches: [ main ]

  # âœ… ë¹Œë“œ ì›Œí¬í”Œë¡œ ì™„ë£Œ ì‹œ ìžë™ ì‹¤í–‰ (ì„±ê³µ/ì‹¤íŒ¨ ëª¨ë‘)
  workflow_run:
    workflows:
      - "âš™ï¸ R3C Cross-Platform Autonomous Build (v6.3 Debug+Safe)"
    types: [completed]
    branches:
      - main

permissions:
  contents: write

jobs:
  self-heal:
    if: >
      github.event_name == 'push' ||
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'repository_dispatch' ||
      github.event.workflow_run.conclusion == 'failure'
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§© Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ§  Diagnostic header
        run: |
          echo "====================================================="
          echo "R3C SELF-FIX WORKFLOW TRIGGERED"
          echo "Event: ${{ github.event_name }}"
          echo "Workflow Run Conclusion: ${{ github.event.workflow_run.conclusion || 'N/A' }}"
          echo "====================================================="

      - name: ðŸ” Check file structure
        run: |
          ls -R include || echo "(no include)"
          ls -R src || echo "(no src)"

      - name: âš™ï¸ Auto-create include/r3c.hpp if missing
        run: |
          mkdir -p include
          if [ ! -f include/r3c.hpp ]; then
            echo "Creating include/r3c.hpp..."
            cat > include/r3c.hpp <<'EOF'
#pragma once
#include <string>
#include <vector>
#include <cstdio>

int run_pipeline(const std::vector<std::string>& args,
                 const std::string& manifest,
                 bool emit_asm,
                 bool emit_rust,
                 const std::string& out_dir,
                 bool verbose);

inline void r3c_banner() {
    printf("=====================================================\n");
    printf("[r3c] Rust LTS transpiler + NASM bootstrap pipeline\n");
    printf("=====================================================\n");
}
EOF
          else
            echo "âœ… include/r3c.hpp already exists."
          fi

      - name: ðŸ“¦ Ensure nlohmann/json.hpp exists
        run: |
          mkdir -p include/nlohmann
          if [ ! -f include/nlohmann/json.hpp ]; then
            echo "Downloading nlohmann/json.hpp..."
            curl -L https://raw.githubusercontent.com/nlohmann/json/develop/single_include/nlohmann/json.hpp \
              -o include/nlohmann/json.hpp
          else
            echo "âœ… JSON header already exists."
          fi

      - name: ðŸ’¾ Commit and push auto-fix
        run: |
          git config user.name "r3c-bot"
          git config user.email "bot@r3c.local"
          git add include src CMakeLists.txt || true
          git commit -m "ðŸ¤– auto-fix (self-heal test)" || echo "No changes"
          git push || echo "No push needed"

      - name: ðŸš€ Trigger test rebuild event (echo)
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.R3C_TOKEN }}
          repository: ${{ github.repository }}
          event-type: test-self-fix
          client-payload: '{"status": "triggered from self-fix.yml"}'

      - name: ðŸ§© Confirmation Log
        run: |
          echo "âœ… Self-fix workflow completed."
          echo "ðŸ§  Event test-self-fix dispatched successfully."
