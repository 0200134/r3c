name: üß† R3C Self-Fix Auto-Heal System (v6 Stable)

on:
  workflow_dispatch:
  push:
    paths:
      - "CMakeLists.txt"
      - ".github/workflows/self-fix.yml"
      - "src/**"
      - "include/**"

jobs:
  self-fix:
    runs-on: ubuntu-latest
    steps:
      - name: üß∞ Checkout repository
        uses: actions/checkout@v4

      - name: üß± Configure & Build
        run: |
          echo "‚öôÔ∏è Building on $RUNNER_OS..."
          cmake -B build -S . -DCMAKE_BUILD_TYPE=Release -DCMAKE_VERBOSE_MAKEFILE=ON
          cmake --build build --parallel 4 || echo "‚ö†Ô∏è Build failed, triggering self-heal..."

      - name: ü©π Auto-Heal CMakeLists if build failed
        if: failure()
        run: |
          echo "ü©π Detected build failure ‚Äì regenerating safe CMakeLists.txt ..."
          cat > CMakeLists.txt <<'EOF'
cmake_minimum_required(VERSION 3.5...3.30)
project(r3c LANGUAGES CXX)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_EXPORT_COMPILE_COMMANDS ON)
set(CMAKE_VERBOSE_MAKEFILE ON)

if (CMAKE_VERSION VERSION_GREATER_EQUAL "3.13")
    cmake_policy(SET CMP0077 NEW)
endif()
if (CMAKE_VERSION VERSION_GREATER_EQUAL "3.5")
    set(CMAKE_POLICY_VERSION_MINIMUM 3.5)
endif()

if (MSVC)
    add_compile_options(/utf-8 /EHsc /permissive- /W3)
else()
    add_compile_options(-Wall -Wextra -Wno-unused-parameter)
endif()

include(FetchContent)
FetchContent_Declare(
  nlohmann_json
  GIT_REPOSITORY https://github.com/nlohmann/json.git
  GIT_TAG v3.11.3
)
FetchContent_MakeAvailable(nlohmann_json)

file(GLOB R3C_SRC CONFIGURE_DEPENDS "src/*.cpp")
file(GLOB R3C_HDR CONFIGURE_DEPENDS "include/**/*.h" "include/**/*.hpp")

add_executable(r3c ${R3C_SRC} ${R3C_HDR})
target_include_directories(r3c PRIVATE ${CMAKE_CURRENT_SOURCE_DIR}/include ${nlohmann_json_SOURCE_DIR}/include)
target_link_libraries(r3c PRIVATE nlohmann_json::nlohmann_json)

foreach(f ${R3C_SRC})
    if (NOT EXISTS ${f})
        get_filename_component(name ${f} NAME_WE)
        message(WARNING "‚ö†Ô∏è Missing source file: ${f}, generating stub -> r3c_stub_${name}()")
        file(WRITE ${f} "// Auto-generated stub\nvoid r3c_stub_${name}() {}\n")
    endif()
endforeach()

message(STATUS "=====================================================")
message(STATUS "[r3c] Cross-Platform Build (v6 Stable, Self-Healed)")
message(STATUS "C++ Compiler : ${CMAKE_CXX_COMPILER}")
message(STATUS "Build Type   : ${CMAKE_BUILD_TYPE}")
message(STATUS "Source Dir   : ${CMAKE_SOURCE_DIR}")
message(STATUS "=====================================================")
message(STATUS "‚úÖ CMake configured successfully after auto-heal.")
EOF

      - name: üîÅ Retry Build After Self-Heal
        run: |
          echo "üîÅ Retrying build..."
          cmake -B build -S . -DCMAKE_BUILD_TYPE=Release -DCMAKE_VERBOSE_MAKEFILE=ON
          cmake --build build --parallel 4

      - name: ‚úÖ Commit and Push Auto-Fix
        if: success()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add CMakeLists.txt
          git commit -m "ü§ñ Auto-healed CMakeLists.txt (v6)"
          git push origin HEAD:main || echo "‚ÑπÔ∏è Tag or branch push skipped"
