name: R3C Solo Autonomous Build & Stable Release (v16-final)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "*" ]
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: ğŸ§° Checkout
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Build Tools
        shell: bash
        run: |
          case "$RUNNER_OS" in
            "Linux") sudo apt-get update && sudo apt-get install -y cmake nasm zip ;;
            "macOS") brew install cmake nasm zip || true ;;
            "Windows") choco install cmake nasm zip -y ;;
          esac

      - name: ğŸª¶ Generate Stub Sources
        shell: bash
        run: |
          echo "ğŸ§© Generating stub source files..."
          if [ -f scripts/generate_stubs.sh ]; then
            chmod +x scripts/generate_stubs.sh
            ./scripts/generate_stubs.sh
          else
            echo "âš ï¸ No stub generator found, skipping..."
          fi
          echo "âœ… Stub generation completed."

      - name: ğŸ”§ Configure
        shell: bash
        run: cmake -B build -S . -DCMAKE_CXX_FLAGS="-Iinclude"

      - name: ğŸ—ï¸ Build Project
        shell: bash
        run: |
          echo "âš™ï¸ Building on $RUNNER_OS..."
          cmake --build build --config Release --parallel 4

      # âœ… ZIP íŒŒì¼ í™•ì‹¤íˆ ìƒì„±
      - name: ğŸ“¦ Package build outputs
        if: success()
        shell: bash
        run: |
          mkdir -p artifacts
          zip -r artifacts/r3c-${{ matrix.os }}.zip build/
          echo "âœ… Created artifacts/r3c-${{ matrix.os }}.zip"

      # âœ… OSë³„ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
      - name: â¬†ï¸ Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: r3c-${{ matrix.os }}
          path: artifacts/*.zip
          retention-days: 30

  release:
    name: ğŸš€ Auto Tag & Stable Release
    runs-on: ubuntu-latest
    needs: build
    if: needs.build.result == 'success'

    steps:
      - name: ğŸ§° Checkout
        uses: actions/checkout@v4

      # âœ… ëª¨ë“  í”Œë«í¼ ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ (ì´ë¦„ íŒ¨í„´ ì¼ì¹˜)
      - name: ğŸ“¥ Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: r3c-*
          path: release_artifacts
          merge-multiple: true

      - name: ğŸ” Verify Artifacts
        run: |
          echo "ğŸ“‚ Listing release_artifacts..."
          ls -R release_artifacts || (echo "âŒ No artifacts found!" && exit 1)

      # âœ… í•­ìƒ ìœ ë‹ˆí¬í•œ íƒœê·¸ ìƒì„± (íƒ€ì„ìŠ¤íƒ¬í”„ í¬í•¨)
      - name: ğŸ·ï¸ Create Git Tag
        run: |
          TAG="auto-stable-$(date +'%Y%m%d-%H%M%S')"
          echo "ğŸ”– Creating tag: $TAG"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag "$TAG"
          git push origin "$TAG"
          echo "TAG=$TAG" >> $GITHUB_ENV

      # âœ… ë¦´ë¦¬ìŠ¤ ìƒì„± (ì´ì „ ì¶©ëŒ ë°©ì§€ ì™„ì „ ë²„ì „)
      - name: ğŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG }}
          name: "R3C Stable Auto Release (${{ env.TAG }})"
          body: |
            ğŸ§± R3C Cross-Platform Autonomous Build
            âœ… Platforms: Linux, macOS, Windows
            âš™ï¸ LLVM-Free Pipeline (C++ â†’ Rust â†’ ASM)
            ğŸ”„ Automated build, stub generation, and packaging
          files: |
            release_artifacts/**/*.zip
            release_artifacts/*.zip
