name: R3C Solo Autonomous Build (v14-cross-safe-release)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "*" ]
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: ğŸ§° Checkout
        uses: actions/checkout@v4

      - name: ğŸ§© Prepare JSON dependency
        shell: bash
        run: |
          mkdir -p include/nlohmann
          if [ ! -f include/nlohmann/json.hpp ]; then
            curl -fsSL https://raw.githubusercontent.com/nlohmann/json/develop/single_include/nlohmann/json.hpp \
              -o include/nlohmann/json.hpp
          fi

      - name: âš™ï¸ Setup Build Tools
        shell: bash
        run: |
          case "$RUNNER_OS" in
            "Linux")
              sudo apt-get update && sudo apt-get install -y cmake nasm zip
              ;;
            "macOS")
              brew install cmake nasm zip || true
              ;;
            "Windows")
              choco install cmake nasm zip -y
              ;;
          esac

      # âœ… Stub ìƒì„±
      - name: ğŸª¶ Generate Stub Sources
        shell: bash
        run: |
          echo "ğŸ§© Generating stub source files..."
          chmod +x scripts/generate_stubs.sh
          ./scripts/generate_stubs.sh
          echo "âœ… Stub generation completed."

      - name: ğŸ”§ Configure
        shell: bash
        run: cmake -B build -S . -DCMAKE_CXX_FLAGS="-Iinclude"

      - name: ğŸ—ï¸ Build Project
        id: build
        shell: bash
        run: |
          echo "âš™ï¸ Building on $RUNNER_OS..."
          attempt=1
          while [ $attempt -le 3 ]; do
            echo "ğŸ” Attempt $attempt..."
            if cmake --build build --config Release --parallel 4; then
              echo "âœ… Build success"
              echo "success=true" >> $GITHUB_OUTPUT
              exit 0
            else
              echo "âš ï¸ Build failed (attempt $attempt)"
              ((attempt++))
            fi
          done
          echo "âŒ Build failed after 3 attempts"
          echo "success=false" >> $GITHUB_OUTPUT
          exit 1

      # âœ… ZIP íŒ¨í‚¤ì§• (ì´ê²Œ ì—†ì–´ì„œ ì´ì „ì— ì—ëŸ¬ ë°œìƒ)
      - name: ğŸ“¦ Package artifacts
        if: success()
        shell: bash
        run: |
          echo "ğŸ“¦ Packaging build outputs..."
          mkdir -p artifacts
          zip -r artifacts/r3c-${{ matrix.os }}.zip build/
          echo "âœ… Artifact created: artifacts/r3c-${{ matrix.os }}.zip"

      # âœ… ì—…ë¡œë“œ (ê° OSë³„ ê²°ê³¼)
      - name: â¬†ï¸ Upload build artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: r3c-${{ matrix.os }}
          path: artifacts/*.zip
          retention-days: 30

  # âœ… ë¦´ë¦¬ìŠ¤ job (Linux ì„±ê³µ ì‹œë§Œ ì‹¤í–‰)
  release:
    name: Release Artifacts
    runs-on: ubuntu-latest
    needs: build
    if: needs.build.result == 'success'

    steps:
      - name: ğŸ§° Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¦ Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: ğŸ” Debug artifacts
        run: ls -R artifacts

      - name: ğŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: auto-stable-v${{ github.run_number }}
          name: "R3C Auto Release v${{ github.run_number }}"
          body: |
            ğŸ”§ Automated Cross-Platform Build (v14)
            âœ… Platforms: Linux, macOS, Windows
            ğŸ§© Includes stubs and JSON headers
          files: artifacts/**/*.zip
