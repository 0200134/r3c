name: R3C Traffic Tracker

on:
  schedule:
    - cron: "0 1 * * *"  # 매일 새벽 1시 (UTC 기준)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-traffic:
    name: Update Traffic Badges
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch traffic data
        id: traffic
        uses: sangonzal/repository-traffic-action@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate badges
        run: |
          CLONES=${{ steps.traffic.outputs.count_clones }}
          VIEWS=${{ steps.traffic.outputs.count_views }}
          UNIQUE_CLONES=${{ steps.traffic.outputs.count_unique_clones }}
          UNIQUE_VIEWS=${{ steps.traffic.outputs.count_unique_views }}
          
          echo "📊 R3C Traffic:"
          echo "- Clones: $CLONES"
          echo "- Views: $VIEWS"

          # 뱃지 이미지 URL 생성
          echo "![Clones](https://img.shields.io/badge/clones-${CLONES}-blue)" > badges.md
          echo "![Views](https://img.shields.io/badge/views-${VIEWS}-orange)" >> badges.md
          echo "![Unique Cloners](https://img.shields.io/badge/unique_cloners-${UNIQUE_CLONES}-purple)" >> badges.md
          echo "![Unique Viewers](https://img.shields.io/badge/unique_viewers-${UNIQUE_VIEWS}-yellow)" >> badges.md

      - name: Update README badges
        run: |
          # README 상단 부분만 자동 교체
          awk '/<!-- TRAFFIC_START -->/{flag=1;print;system("cat badges.md");next}/<!-- TRAFFIC_END -->/{flag=0} !flag' README.md > README_new.md
          mv README_new.md README.md

      - name: Commit and push
        run: |
          git config --global user.name "r3c-bot"
          git config --global user.email "r3c-bot@users.noreply.github.com"
          git add README.md
          git commit -m "update: traffic badges [auto]" || echo "no changes"
          git push
