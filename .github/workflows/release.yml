name: R3C Cross-Platform Build & Release (v6 Safe-Stub)

on:
  push:
    tags:
      - '*'
  workflow_dispatch:

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: 🧱 Checkout repository
        uses: actions/checkout@v4

      - name: ⚙️ Setup CMake
        uses: jwlawson/actions-setup-cmake@v2
        with:
          cmake-version: '3.30.2'

      - name: 🔧 Configure build
        run: |
          cmake -B build -S . -DCMAKE_BUILD_TYPE=Release -DCMAKE_VERBOSE_MAKEFILE=ON

      - name: 🏗 Build (auto-heal)
        run: |
          attempt=1
          until cmake --build build --config Release --parallel 4 || [ $attempt -gt 3 ]; do
            echo "⚠️ Build failed attempt $attempt"
            rm -rf build
            cmake -B build -S .
            attempt=$((attempt+1))
          done

      - name: 🧪 Verify binary
        run: |
          echo "Built files:"
          ls -l build || true

      - name: 📦 Upload artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: r3c-${{ matrix.os }}
          path: build/
