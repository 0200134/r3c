name: R3C Activity Dashboard

on:
  schedule:
    - cron: "0 * * * *"  # 매시간 자동 업데이트
  workflow_dispatch:

permissions:
  contents: write

jobs:
  dashboard:
    name: Generate Dashboard
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Gather stats
        id: gather
        run: |
          echo "🧠 Collecting R3C activity data..."
          CLONES=$(curl -s -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/traffic/clones \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" | jq '.count')
          VIEWS=$(curl -s -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/traffic/views \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" | jq '.count')

          LAST_RELEASE=$(curl -s -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/releases/latest | jq -r '.name // "N/A"')

          BUILDS=$(tail -n 5 logs/R3C_Build_History.md 2>/dev/null || echo "No build logs")

          echo "clones=$CLONES" >> $GITHUB_OUTPUT
          echo "views=$VIEWS" >> $GITHUB_OUTPUT
          echo "release=$LAST_RELEASE" >> $GITHUB_OUTPUT
          echo "builds=$BUILDS" >> $GITHUB_OUTPUT

      - name: Generate dashboard
        run: |
          echo "## ⚙️ R3C Activity Dashboard" > DASHBOARD.md
          echo "" >> DASHBOARD.md
          echo "| 항목 | 값 |" >> DASHBOARD.md
          echo "|------|----|" >> DASHBOARD.md
          echo "| 🧩 최근 릴리스 | ${{ steps.gather.outputs.release }} |" >> DASHBOARD.md
          echo "| 👀 총 조회수 | ${{ steps.gather.outputs.views }} |" >> DASHBOARD.md
          echo "| 📦 총 클론 수 | ${{ steps.gather.outputs.clones }} |" >> DASHBOARD.md
          echo "" >> DASHBOARD.md
          echo "### 🧠 최근 빌드 로그 (최근 5회)" >> DASHBOARD.md
          echo '```' >> DASHBOARD.md
          echo "${{ steps.gather.outputs.builds }}" >> DASHBOARD.md
          echo '```' >> DASHBOARD.md
          echo "" >> DASHBOARD.md
          echo "_자동 갱신: $(date -u '+%Y-%m-%d %H:%M UTC')_" >> DASHBOARD.md

      - name: Update README section
        run: |
          awk '/<!-- DASHBOARD_START -->/{flag=1;print;system("cat DASHBOARD.md");next}/<!-- DASHBOARD_END -->/{flag=0} !flag' README.md > README_new.md
          mv README_new.md README.md

      - name: Commit and push
        run: |
          git config --global user.name "r3c-bot"
          git config --global user.email "r3c-bot@users.noreply.github.com"
          git add README.md
          git commit -m "update: R3C activity dashboard [auto]" || echo "no changes"
          git push
